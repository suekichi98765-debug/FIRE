<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿½åŠ æŠ•è³‡</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .instruction-box {
            background-color: #f0f8ff;
            border-left: 5px solid #3498db;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .tuika-item {
            background: #fff;
            padding: 15px;
            border: 1px solid #e0eaf3;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .input-group label {
            margin-bottom: 0;
            white-space: nowrap;
        }
        .input-group input, .input-group select {
            width: auto;
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .tuika-item .remove-btn {
            background-color: #e74c3c;
            color: #fff;
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 14px;
            margin-top: 10px;
        }
        /* ã‚¨ãƒ©ãƒ¼å…¥åŠ›æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .error-input {
            border: 2px solid #e74c3c !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>è¿½åŠ æŠ•è³‡</h1>
            <p>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æœŸé–“ä¸­ã«ä¸€åº¦ã ã‘è¡Œã‚ã‚Œã‚‹è¿½åŠ æŠ•è³‡ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®šã—ã¾ã™ã€‚</p>
        </header>

        <main>
            <div class="input-section">
                <h2>è¿½åŠ æŠ•è³‡ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§</h2>
                
                <div class="instruction-box">
                    <p>ğŸ’¡ <strong>å…¥åŠ›æ–¹æ³•:</strong></p>
                    <ul>
                        <li>**è¿½åŠ æŠ•è³‡å¹´æœˆï¼ˆå¹´/æœˆï¼‰:** è¿½åŠ æŠ•è³‡ãŒ**ä¸€å›ã ã‘**è¡Œã‚ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’è¨­å®šã—ã¾ã™ã€‚</li>
                        <li>**æŠ•è³‡é¡:** ãã®æœˆã«ä¸€å›æŠ•è³‡ã™ã‚‹é‡‘é¡ï¼ˆå††ï¼‰ã‚’å…¥åŠ›ã—ã¾ã™ã€‚</li>
                        <li>**0å¹´0æœˆã¾ãŸã¯0å¹´1æœˆ:** ã©ã¡ã‚‰ã‚‚ã€Œã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹æœˆã€ã‚’æ„å‘³ã—ã¾ã™ã€‚</li>
                        <li>**ã€é‡è¦ã€‘å£²è²·ä¾¡é¡ã«ã¤ã„ã¦:** ã“ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€è¨­å®šã•ã‚ŒãŸæœˆã®**æœˆåˆï¼ˆå‰æœˆæœ«ã®çµ‚å€¤ï¼‰**ã®ä¾¡é¡ã§å£²è²·ãŒè¡Œã‚ã‚Œã¾ã™ã€‚ãã®æœˆã®å¸‚å ´å¤‰å‹•ã®å½±éŸ¿ã‚’å—ã‘ã‚‹å‰ã®ä¾¡é¡ãŒé©ç”¨ã•ã‚Œã¾ã™ã€‚</li>
                    </ul>
                </div>

                <div id="tuikaContainer">
                    </div>
                
                <div class="form-actions">
                    <button id="addTuikaBtn" type="button" class="nav-button">æŠ•è³‡ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ </button>
                    <button id="saveTuikaBtn" class="save-button">è¨­å®šã‚’ä¿å­˜</button>
                </div>
            </div>

            <div class="back-link">
                <a href="index.html" class="nav-button">ãƒ¡ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹</a>
            </div>
        </main>
    </div>

    <script src="app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tuikaContainer = document.getElementById('tuikaContainer');
            const addTuikaBtn = document.getElementById('addTuikaBtn');
            const saveTuikaBtn = document.getElementById('saveTuikaBtn');

            // stocks.htmlã§è¨­å®šã•ã‚ŒãŸéŠ˜æŸ„ãƒªã‚¹ãƒˆã‚’å–å¾—
            const appData = JSON.parse(localStorage.getItem('fireSimulatorData')) || {};
            const stocks = appData.stocks || [];

            // éŠ˜æŸ„é¸æŠç”¨ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³HTMLã‚’ç”Ÿæˆ
            const generateStockOptions = (selectedValue = '') => {
                let options = stocks.map(stock => 
                    `<option value="${stock.Meigara}" ${stock.Meigara === selectedValue ? 'selected' : ''}>${stock.Meigara}</option>`
                ).join('');
                // éŠ˜æŸ„ãŒä¸€ã¤ã‚‚ãªã„å ´åˆã¯é¸æŠè‚¢ã‚’ç„¡åŠ¹åŒ–
                if (stocks.length === 0) {
                    options = '<option value="" disabled selected>éŠ˜æŸ„ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</option>';
                }
                return options;
            };

            // æ•°å€¤ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¡¨ç¤ºã—ã€å¤‰æ›´æ™‚ã«ã‚«ãƒ³ãƒã‚’è‡ªå‹•æŒ¿å…¥ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
            const setupAmountInput = (inputElement) => {
                const initialValue = inputElement.value;
                if (initialValue && !isNaN(parseInt(initialValue.replace(/,/g, '')))) {
                    inputElement.value = window.formatNumber(parseInt(initialValue));
                }

                inputElement.addEventListener('blur', (e) => {
                    const value = e.target.value.replace(/,/g, '');
                    if (!isNaN(value) && value !== '') {
                        e.target.value = window.formatNumber(parseInt(value, 10));
                    }
                });

                inputElement.addEventListener('focus', (e) => {
                    e.target.value = e.target.value.replace(/,/g, '');
                });
            };

            // æŠ•è³‡ã‚¢ã‚¤ãƒ†ãƒ ã®ç•ªå·ã‚’æ›´æ–°ã™ã‚‹
            const updateTuikaNumbers = () => {
                document.querySelectorAll('.tuika-item h3').forEach((header, index) => {
                    header.textContent = `è¿½åŠ æŠ•è³‡ã‚¤ãƒ™ãƒ³ãƒˆ #${index + 1}`;
                });
            };

            // è¿½åŠ æŠ•è³‡ã‚¢ã‚¤ãƒ†ãƒ ã®HTMLã‚’ç”Ÿæˆãƒ»DOMã«è¿½åŠ 
            const createTuikaItem = (data = { month: 0, meigara: stocks.length > 0 ? stocks[0].Meigara : '', amount: 0 }) => {
                const year = Math.floor(data.month / 12);
                const month = (data.month % 12) + 1; // 1-12æœˆã«æˆ»ã™
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('tuika-item');
                
                // HTMLç”Ÿæˆ
                itemDiv.innerHTML = `
                    <h3>è¿½åŠ æŠ•è³‡ã‚¤ãƒ™ãƒ³ãƒˆ</h3>
                    <div class="input-group">
                        <label>**è¿½åŠ æŠ•è³‡å¹´æœˆï¼ˆå¹´/æœˆï¼‰:**</label>
                        <input type="number" class="tuika-year" value="${year}" min="0" required placeholder="å¹´"> / 
                        <input type="number" class="tuika-month" value="${month}" min="1" max="12" required placeholder="æœˆ">
                    </div>
                    <div class="input-group">
                        <label>éŠ˜æŸ„:</label>
                        <select class="tuika-meigara" required ${stocks.length === 0 ? 'disabled' : ''}>
                            ${generateStockOptions(data.meigara)}
                        </select>
                    </div>
                    <div class="input-group">
                        <label>æŠ•è³‡é¡ï¼ˆå††ï¼‰:</label>
                        <input type="text" class="tuika-amount" value="${data.amount}" required>
                    </div>
                    <button type="button" class="nav-button remove-btn">å‰Šé™¤</button>
                `;

                const amountInput = itemDiv.querySelector('.tuika-amount');
                setupAmountInput(amountInput); // æŠ•è³‡é¡å…¥åŠ›æ¬„ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’è¨­å®š

                const removeBtn = itemDiv.querySelector('.remove-btn');
                removeBtn.addEventListener('click', () => {
                    itemDiv.remove();
                    updateTuikaNumbers();
                });

                tuikaContainer.appendChild(itemDiv);
                updateTuikaNumbers();
            };

            const addTuikaItem = () => {
                createTuikaItem();
            };

            // ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã€è¡¨ç¤ºã™ã‚‹é–¢æ•°
            const loadTuika = () => {
                tuikaContainer.innerHTML = '';
                const appData = JSON.parse(localStorage.getItem('fireSimulatorData')) || {};
                const tuikaData = appData.tuika || [];

                if (tuikaData.length === 0) {
                    addTuikaItem(); // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯åˆæœŸã‚¢ã‚¤ãƒ†ãƒ ã‚’ä¸€ã¤è¿½åŠ 
                } else {
                    tuikaData.forEach(data => createTuikaItem(data));
                }
            };
            
            // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š ---
            addTuikaBtn.addEventListener('click', addTuikaItem);

            saveTuikaBtn.addEventListener('click', () => {
                const tuikaData = [];
                let isValid = true;
                
                document.querySelectorAll('.tuika-item').forEach(itemDiv => {
                    const yearInput = itemDiv.querySelector('.tuika-year');
                    const monthInput = itemDiv.querySelector('.tuika-month');
                    const meigaraInput = itemDiv.querySelector('.tuika-meigara');
                    const amountInput = itemDiv.querySelector('.tuika-amount');

                    const year = parseInt(yearInput.value, 10);
                    const month = parseInt(monthInput.value, 10);
                    const meigara = meigaraInput.value;
                    const amount = parseInt(amountInput.value.replace(/,/g, ''), 10); // ã‚«ãƒ³ãƒã‚’å‰Šé™¤ã—ã¦æ•°å€¤ã«å¤‰æ›
                    
                    const totalMonths = year * 12 + (month - 1); // 0-11ã®æœˆã«å¤‰æ›

                    if (isNaN(year) || isNaN(month) || isNaN(amount) || year < 0 || month < 1 || month > 12 || amount < 0 || !meigara) {
                        isValid = false;
                        yearInput.classList.add('error-input');
                        monthInput.classList.add('error-input');
                        amountInput.classList.add('error-input');
                        meigaraInput.classList.add('error-input');
                        return; // forEachã‹ã‚‰æŠœã‘ã‚‹
                    } else {
                        // ã‚¨ãƒ©ãƒ¼ãŒè§£æ¶ˆã•ã‚ŒãŸå ´åˆã¯ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å…ƒã«æˆ»ã™
                        yearInput.classList.remove('error-input');
                        monthInput.classList.remove('error-input');
                        amountInput.classList.remove('error-input');
                        meigaraInput.classList.remove('error-input');
                    }
                    
                    tuikaData.push({
                        month: totalMonths,
                        meigara: meigara,
                        amount: amount
                    });
                });

                if (!isValid) {
                    alert('å…¨ã¦ã®é …ç›®ã«æ­£ã—ã„æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚å¹´æ•°ã¯0ä»¥ä¸Šã€æœˆã¯1ã‹ã‚‰12ã¾ã§ã®æ•°å€¤ã€æŠ•è³‡é¡ã¯0ä»¥ä¸Šã®æ•°å€¤ã‚’å…¥åŠ›ã—ã€éŠ˜æŸ„ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                // ç·æœˆæ•°ã§ã‚½ãƒ¼ãƒˆã—ã¦ä¿å­˜
                const sortedTuikaData = tuikaData.sort((a, b) => a.month - b.month); 
                
                const appData = JSON.parse(localStorage.getItem('fireSimulatorData')) || {}; 
                appData.tuika = sortedTuikaData;
                localStorage.setItem('fireSimulatorData', JSON.stringify(appData));
                alert('è¿½åŠ æŠ•è³‡ã®è¨­å®šãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼');
                
                // ä¿å­˜å¾Œã«å†ãƒ­ãƒ¼ãƒ‰ã—ã¦è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆã‚«ãƒ³ãƒãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®å†é©ç”¨ãªã©ï¼‰
                loadTuika();
            });

            loadTuika();
        });
    </script>
</body>
</html>