<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIREã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</title>
    <style>
        /* 4.4. ãƒ‡ã‚¶ã‚¤ãƒ³ - ãƒ–ãƒ©ã‚¦ã‚¶ã‚µã‚¤ã‚ºã¾ã§åºƒã’ã€åã¾ã‚‰ãªã„ã¨ãã¯å‚ç›´ãƒ»æ°´å¹³ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§è¡¨ç¤º */
        body {
            max-width: none !important;
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f4f7;
            color: #333;
            min-width: 1000px;
            /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç™ºç”Ÿã•ã›ã‚„ã™ãã™ã‚‹ãŸã‚ã®æœ€å°å¹… */
        }

        h1,
        h2 {
            text-align: center;
            color: #2c3e50;
        }

        .simulation-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            /* ãƒœã‚¿ãƒ³é–“ã®é–“éš”ã‚’èª¿æ•´ */
            justify-content: flex-start;
            /* å·¦æƒãˆ */
            margin-top: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .simulation-button {
            /* è©¦è¡Œå›æ•°ã®æ•°å­—ã®ã¿ã‚’ãƒ†ã‚­ã‚¹ãƒˆã¨ã™ã‚‹ãƒœã‚¿ãƒ³ã‚’æ¨ªã«æœ€å¤§25å€‹ã€å·¦æƒãˆã§å‡ç­‰é…ç½®ã€‚ */
            flex-basis: calc(3%);
            /* 5pxã®ã‚®ãƒ£ãƒƒãƒ—ã§25å€‹ä¸¦ã¹ã‚‹ãŸã‚ã®è¨ˆç®— */
            height: 30px;
            border-radius: 5px;
            border: 1px solid #ccc;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease;
            text-align: center;
            line-height: 30px;
            font-size: 12px;
            padding: 0;
        }

        /* 4.2. æˆåŠŸ/å¤±æ•—ãƒœã‚¿ãƒ³ */
        .success {
            background-color: #3498db;
        }

        /* é’è‰²: FIREæˆåŠŸ */
        .failure {
            background-color: #e74c3c;
        }

        /* èµ¤è‰²: FIREå¤±æ•— */
        .simulation-button:hover {
            opacity: 0.8;
        }

        .active-chart-button {
            /* ã‚°ãƒ©ãƒ•ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
            box-shadow: 0 0 5px 3px #f39c12; /* ã‚ªãƒ¬ãƒ³ã‚¸è‰²ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
            border: 2px solid #e67e22;
        }

        /* ã‚°ãƒ©ãƒ•ã‚³ãƒ³ãƒ†ãƒŠã«ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã‚’ä¿ƒã™ã‚«ãƒ¼ã‚½ãƒ«ã‚’è¿½åŠ ï¼ˆä»»æ„ï¼‰ */
        #totalAssetChart {
            cursor: pointer;
        }


        /* 4.3. ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        #detail-table-container {
            width: 100%;
            overflow-x: auto;
            /* æ°´å¹³ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
            margin-top: 30px;
            border: 1px solid #ccc;
            background-color: #fff;
        }

        #detail-table {
            width: 100%;
            font-size: 12px;
            table-layout: fixed;
            /* ã‚«ãƒ©ãƒ å¹…ã‚’å›ºå®š */
        }

        /* 4.3. ãƒ†ãƒ¼ãƒ–ãƒ«å›ºå®šè¡¨ç¤º: ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¦‹å‡ºã—ï¼ˆ2è¡Œæ§‹æˆï¼‰ã¯ã€ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã‚‚å¸¸ã«æœ€ä¸Šéƒ¨ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†å›ºå®šã€‚ */
        #detail-table thead {
            background-color: #f9f9f9;
            /* è¦‹å‡ºã—ã®èƒŒæ™¯è‰² */
        }

        #detail-table th,
        #detail-table td {
            border: 1px solid #ddd;
            text-align: center;
            vertical-align: middle;
            white-space: nowrap;
            /* ã‚»ãƒ«å†…ã®æ”¹è¡Œã‚’é˜²ãï¼ˆthã¯æ”¹è¡Œã‚¿ã‚°ã§åˆ¶å¾¡ï¼‰ */
        }

        #detail-table th {
            background-color: #e9ecef;
            color: #495057;
            text-align: center;
            vertical-align: middle;
        }

        /* å…±é€šé …ç›®ã®ã‚«ãƒ©ãƒ å¹…ã‚’å›ºå®š */
        #detail-table tr th:nth-child(1) {}

        ,
        #detail-table tr td:nth-child(1) {}

        /* (1) å¹´æœˆ */
        #detail-table th:nth-child(2),
        #detail-table td:nth-child(2) {}

        /* (2) å¼•ç¶™é‡‘èè³‡ç”£é¡ */
        #detail-table th:nth-child(3),
        #detail-table td:nth-child(3) {}

        /* (3) å‡ºè²» */
        #detail-table th:nth-child(4),
        #detail-table td:nth-child(4) {}

        /* (4) åå…¥ */
        #detail-table th:nth-child(5),
        #detail-table td:nth-child(5) {}

        /* (5) ç¨é‡‘ */
        #detail-table th:nth-child(6),
        #detail-table td:nth-child(6) {}

        /* (6) ä¿æœ‰ç¾é‡‘ */
        #detail-table th:nth-child(7),
        #detail-table td:nth-child(7) {}

        /* (7) è¿½åŠ æŠ•è³‡ */
        #detail-table th:nth-child(8),
        #detail-table td:nth-child(8) {}

        /* (8) æœŸæœ«é‡‘èè³‡ç”£é¡ */
        #detail-table th:nth-child(9),
        #detail-table td:nth-child(9) {}

        /* (9) ç·è³‡ç”£ */

        /* éŠ˜æŸ„ã”ã¨ã®è©³ç´°ã‚«ãƒ©ãƒ å¹…ã®å›ºå®š (4åˆ—: 60 + 100 + 100 + 130 = 390px) */
        /* éŠ˜æŸ„ã”ã¨ã®è©³ç´°åˆ—ã¯10åˆ—ç›®ã‹ã‚‰é–‹å§‹ */
        #detail-table td:nth-child(4n + 10) {}

        /* åˆ©ç‡% */
        #detail-table td:nth-child(4n + 11) {}

        /* é‡‘èè³‡ç”£é¡ */
        #detail-table td:nth-child(4n + 12) {}

        /* ä¿æœ‰å£æ•°ã®æ®‹æ•° */
        #detail-table td:nth-child(4n + 13) {}

        /* ç¾åœ¨/å¹³å‡ï¼ˆç¨é‡‘/1å£ã‚ãŸã‚Šï¼‰ */

        /* éŠ˜æŸ„ã”ã¨ã®ï¼‘è¡Œç›®ã®éŠ˜æŸ„æ¯ã®é›†å›£é …ç›®*/
        .meigara-header-group {
            cursor: pointer;
            /* ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ */
            color: initial;
        }

        .meigara-header-group.collapsed {
            background-color: #fce7e4;
            /* ç¸®å°ä¸­ã§ã‚ã‚‹ã“ã¨ã‚’è¦–è¦šçš„ã«ç¤ºã™ */
            width: 60px !important;
            min-width: 60px !important;
            max-width: 60px !important;
            padding: 0 5px !important;
            /* éŠ˜æŸ„åãŒè¦–èªã§ãã‚‹ç¨‹åº¦ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ®‹ã™ */
            white-space: nowrap;
            /* ãƒ†ã‚­ã‚¹ãƒˆãŒæŠ˜ã‚Šè¿”ã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ */
            overflow: hidden;
            text-overflow: ellipsis;
            /* å¿…è¦ã«å¿œã˜ã¦ã€éŠ˜æŸ„åã‚’çœç•¥è¨˜å·ã§è¡¨ç¤º */
        }

        .collapsed-detail-text {
            /* æœ€å°ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã«è¨­å®š (è¦–èªä¸å¯) */
            font-size: 1px !important;
            /* æ–‡å­—è‰²ã‚’é€æ˜ã«ã—ãŸã„å ´åˆã¯ color: transparent ã‚‚è¿½åŠ ã§ãã¾ã™ãŒã€æœ€å°ã‚µã‚¤ã‚ºã§ååˆ†ã§ã™ */
            color: transparent !important;
        }


        .kuchisu-increase {
            font-weight: bold;
            /* å£æ•°å¢—åŠ æ™‚ã¯å¤ªå­— */
            color: #27ae60;
        }

        .text-left {
            text-align: left;
        }

        .result-stats {
            margin-top: 20px;
            font-size: 1.1em;
            text-align: center;
        }

        /* å‡¡ä¾‹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #meigara-legend {
            margin-top: 20px;
            padding: 15px;
            background-color: #f0f8ff;
            border: 1px solid #b3d4ff;
            border-radius: 5px;
            text-align: left;
            /* å·¦å¯„ã› */
        }

        #meigara-legend h3 {
            margin-top: 0;
            font-size: 1.2em;
            color: #3498db;
        }

        /* 5.4. ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ */
        #debug-output {
            margin-top: 30px;
            padding: 15px;
            border: 1px solid #e74c3c;
            background-color: #fbe7e4;
            color: #c0392b;
            font-family: monospace;
            white-space: pre-wrap;
            display: none;
            /* åˆæœŸã¯éè¡¨ç¤º */
        }
    </style>
</head>

<body>
    <header>
        <h1>FIREã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ</h1>
        <a href="index.html" class="nav-button" style="display: block; width: 200px; margin: 0 auto 20px;">ãƒ¡ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹</a>
    </header>

    <main>
        <section id="results-summary">

        <div id="dynamic-chart-container" style="display: none; width: 95%; margin: 20px auto; min-height: 350px;">
            <canvas id="totalAssetChart"></canvas>
        </div>

            <h2>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã®æ¦‚è¦</h2>
            <div class="result-stats">
                <p id="summary-text">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>

            <div class="filter-controls" style="text-align: center; margin-bottom: 20px;">
                <label for="failure-filter">
                    <input type="checkbox" id="failure-filter"> å¤±æ•—ã—ãŸã‚±ãƒ¼ã‚¹ã®ã¿è¡¨ç¤º
                </label>
            </div>

            <div id="simulation-buttons" class="simulation-buttons">
            </div>
        </section>

        <section id="simulation-detail" style="display: none;">
            <h2 id="detail-title" style="text-align: left;">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è©³ç´°ï¼ˆè©¦è¡Œ #1ï¼‰</h2>

            <div id="meigara-legend">
                <h3>å‡¡ä¾‹</h3>
            </div>

            <div id="detail-table-container">
                <table id="detail-table">
                    <thead>
                        <tr id="header-row-1">
                            <th class="text-left" id="header-row-1-month" rowspan="2">(1)<br>å¹´æœˆ</th>
                        </tr>
                        <tr id="header-row-2">
                            <th>(2) å¼•ç¶™<br>é‡‘èè³‡ç”£é¡</th>
                            <th>(3) å‡ºè²»</th>
                            <th>(4) åå…¥</th>
                            <th>(5) ç¨é‡‘</th>
                            <th>(6) ä¿æœ‰ç¾é‡‘</th>
                            <th>(7) è¿½åŠ æŠ•è³‡</th>
                            <th>(8) æœŸæœ«<br>é‡‘èè³‡ç”£é¡</th>
                            <th>(9) ç·è³‡ç”£</th>
                        </tr>
                    </thead>
                    <tbody id="detail-table-body">
                    </tbody>
                </table>
            </div>
        </section>

        <div id="debug-output">
            <h3>ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›</h3>
            <pre id="debug-content"></pre>
        </div>

    </main>

    <script src="app.js"></script>
    <script src="chart.min.js"></script>

    <script>
        // --- numeric.js (æœ€å°é™ã®æ©Ÿèƒ½ã®ã¿ã‚’æƒ³å®šã—ã¦ã€ã“ã“ã§ã¯ãƒ€ãƒŸãƒ¼é–¢æ•°ã‚’å®šç¾©ã—ã¾ã™ã€‚å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã«å·®ã—æ›¿ãˆã¦ãã ã•ã„ã€‚) ---
        const numeric = {
            rep: (row, col, value = 0) => {
                const matrix = [];
                for (let i = 0; i < row; i++) {
                    matrix.push(new Array(col).fill(value));
                }
                return matrix;
            },
            dot: (A, B) => {
                if (A[0].length !== B.length) {
                    console.error("è¡Œåˆ—ã®æ¬¡å…ƒãŒä¸€è‡´ã—ã¾ã›ã‚“");
                    return numeric.rep(A.length, B[0].length, 0);
                }
                const result = numeric.rep(A.length, B[0].length);
                for (let i = 0; i < A.length; i++) {
                    for (let j = 0; j < B[0].length; j++) {
                        let sum = 0;
                        for (let k = 0; k < A[0].length; k++) {
                            sum += A[i][k] * B[k][j];
                        }
                        result[i][j] = sum;
                    }
                }
                return result;
            },
            identity: (n) => {
                const matrix = numeric.rep(n, n);
                for (let i = 0; i < n; i++) {
                    matrix[i][i] = 1;
                }
                return matrix;
            },
            cholesky: (R) => {
                const n = R.length;
                const L = numeric.rep(n, n);
                for (let i = 0; i < n; i++) {
                    for (let j = 0; j <= i; j++) {
                        if (i === j) {
                            let sum = 0;
                            for (let k = 0; k < j; k++) {
                                sum += L[j][k] * L[j][k];
                            }
                            const diagVal = R[i][i] - sum;
                            if (diagVal < 0) {
                                throw new Error(`ã‚³ãƒ¬ã‚¹ã‚­ãƒ¼åˆ†è§£ã‚¨ãƒ©ãƒ¼: è² ã®å¯¾è§’è¦ç´  (${diagVal.toFixed(4)})`);
                            }
                            L[i][j] = Math.sqrt(diagVal);
                        } else {
                            let sum = 0;
                            for (let k = 0; k < j; k++) {
                                sum += L[i][k] * L[j][k];
                            }
                            if (L[j][j] === 0) {
                                L[i][j] = 0;
                            } else {
                                L[i][j] = (R[i][j] - sum) / L[j][j];
                            }
                        }
                    }
                }
                return L;
            },
            transpose: (M) => {
                const rows = M.length;
                const cols = M[0].length;
                const result = numeric.rep(cols, rows);
                for (let i = 0; i < rows; i++) {
                    for (let j = 0; j < cols; j++) {
                        result[j][i] = M[i][j];
                    }
                }
                return result;
            },
            random: {
                normal: (mu = 0, sigma = 1) => {
                    let u = 0, v = 0;
                    while (u === 0) u = Math.random();
                    while (v === 0) v = Math.random();
                    let mag = sigma * Math.sqrt(-2.0 * Math.log(u));
                    return mag * Math.cos(2.0 * Math.PI * v) + mu;
                }
            }
        };
        // --- numeric.js çµ‚äº† ---


        // --- ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­ãƒ»ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’é–¢æ•°ã«åˆ†å‰² ---

        const debugOutput = (message) => {
            const debugDiv = document.getElementById('debug-output');
            const debugContent = document.getElementById('debug-content');
            if (debugDiv && debugContent) {
                // debugDiv.style.display = 'block'; // ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºã‚’æœ‰åŠ¹ã«ã™ã‚‹å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆè§£é™¤
                debugContent.textContent += message + '\n';
            }
        };

        /**
         * æœˆæ¬¡ç¨ç‡ã‚’æ±ºå®šã™ã‚‹
         */
        function calculateTaxRate(monthIndex, taxEvents) {
            let rate = 0.20315; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 20.315%
            const taxRateEvent = taxEvents.slice().reverse().find(t => monthIndex >= t.month);
            if (taxRateEvent) {
                rate = taxRateEvent.rate / 100;
            }
            return rate;
        }


        /**
         * åå…¥ã¨å‡ºè²»ã‚’å‡¦ç†ã—ã€ç¾é‡‘æ®‹é«˜ã‚’æ›´æ–°ã—ã€ä¸è¶³é¡ã‚’è¿”ã™
         * @param {number} monthIndex - ç¾åœ¨ã®çµŒéæœˆæ•°
         * @param {number} currentCash - ç¾åœ¨ã®ä¿æœ‰ç¾é‡‘
         * @param {object} appData - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿
         * @param {number} currentMonthlyLifeCost - ã‚¤ãƒ³ãƒ•ãƒ¬é©ç”¨æ¸ˆã¿ã®ç¾åœ¨ã®æœˆæ¬¡ç”Ÿæ´»è²»
         */
        function handleIncomeAndExpense(monthIndex, currentCash, appData, currentMonthlyLifeCost) {
            const { bigExpense, income } = appData;

            // 1. åå…¥å‡¦ç† 
            const incomeEvent = income.find(inc =>
                monthIndex >= inc.startTotalMonths &&
                (inc.endTotalMonths === null || inc.endTotalMonths === undefined || monthIndex <= inc.endTotalMonths)
            );
            const monthlyIncome = incomeEvent ? incomeEvent.amount : 0;
            currentCash += monthlyIncome;

            // 2. å‡ºè²»å‡¦ç†
            const baseLifeCost = currentMonthlyLifeCost;

            // å¤§å£å‡ºè²»ã‚’æ¤œç´¢
            const bigExpenseEvent = bigExpense.find(be => be.month === monthIndex);
            const bigExpenseAmount = bigExpenseEvent ? bigExpenseEvent.amount : 0;

            // æœˆæ¬¡ç·å‡ºè²» (è¡¨ç¤ºç”¨/è¨ˆç®—ç”¨)
            const monthlyTotalExpense = baseLifeCost + bigExpenseAmount;

            let requiredAssetSale = 0; // ä¸è¶³é¡ï¼ˆè³‡ç”£å£²å´ãŒå¿…è¦ãªé¡ï¼‰
            let cashBalance = currentCash;

            if (cashBalance >= monthlyTotalExpense) {
                cashBalance -= monthlyTotalExpense;
            } else {
                requiredAssetSale = monthlyTotalExpense - cashBalance; // ä¸è¶³é¡
                cashBalance = 0;
            }

            return {
                currentCash: cashBalance,
                monthlyIncome: monthlyIncome,
                totalExpense: monthlyTotalExpense, // (3) å‡ºè²»è¡¨ç¤ºç”¨ã¯ã€ã‚·ãƒ³ãƒ—ãƒ«ã«æœˆæ¬¡ç·å‡ºè²»ã‚’è¿”ã™
                requiredAssetSale: requiredAssetSale // ä¸è¶³é¡
            };
        }



        /**
         * è¿½åŠ æŠ•è³‡ã‚’å‡¦ç†ã—ã€ä¿æœ‰å£æ•°ã¨å¹³å‡å–å¾—ä¾¡é¡ã‚’æ›´æ–°ã™ã‚‹
         */
        function handleTuikaInvestment(monthIndex, currentCash, currentStocks, appData, meigaraNames) {
            const tuikaEvents = appData.tuika.filter(tui => tui.month === monthIndex);
            let monthlyTuikaInvestment = 0;

            for (const tuika of tuikaEvents) {
                const targetStockIndex = meigaraNames.indexOf(tuika.meigara);
                if (targetStockIndex === -1) continue;

                const targetStock = currentStocks[targetStockIndex];
                const investmentAmount = tuika.amount;

                if (currentCash < investmentAmount) {
                    debugOutput(`è¿½åŠ æŠ•è³‡å¤±æ•—(${tuika.meigara}): ç¾é‡‘ä¸è¶³ã€‚`);
                    continue;
                }

                currentCash -= investmentAmount;
                monthlyTuikaInvestment += investmentAmount;

                const pricePerUnit = targetStock.CurrentValuePerUnit / targetStock.Tani;
                if (pricePerUnit <= 0) continue;

                const boughtKuchisu = Math.floor(investmentAmount / pricePerUnit);

                const oldTotalValue = targetStock.Kuchisu * (targetStock.AveragePrice / targetStock.Tani);
                const newTotalValue = oldTotalValue + investmentAmount;
                const newTotalKuchisu = targetStock.Kuchisu + boughtKuchisu;

                targetStock.Kuchisu = newTotalKuchisu;

                if (newTotalKuchisu > 0) {
                    const newAveragePricePerUnit = newTotalValue / newTotalKuchisu;
                    targetStock.AveragePrice = newAveragePricePerUnit * targetStock.Tani;
                }
                debugOutput(`è¿½åŠ æŠ•è³‡æˆåŠŸ(${tuika.meigara}): æŠ•è³‡é¡${investmentAmount}, è³¼å…¥å£æ•°${boughtKuchisu}`);
            }

            return { currentCash, monthlyTuikaInvestment };
        }

        /**
         * ç¾é‡‘ä¸è¶³ã‚’è£œã†ãŸã‚ã«é‡‘èè³‡ç”£ã‚’å£²å´ã™ã‚‹
         */
        function handleAssetSale(requiredExpense, currentCash, currentStocks, trialCurrentTaxRate, monthIndex) {
            let sellProceeds = 0;
            let taxPayment = 0;
            let fireFailure = false;

            let totalFinancialAssets = currentStocks.reduce((sum, s) => {
                const valuePerUnit = s.CurrentValuePerUnit / s.Tani;
                return sum + (s.Kuchisu * valuePerUnit);
            }, 0);

            if (totalFinancialAssets < requiredExpense) {
                fireFailure = true;
                return { currentCash, taxPayment, sellProceeds, fireFailure };
            }

            let netSaleAmountNeeded = requiredExpense;
            let requiredSaleProceeds = netSaleAmountNeeded; // å£²å´ç·é¡ï¼ˆç¨å¼•ãå‰ï¼‰ã®ç›®æ¨™

            const MAX_SELL_TRIALS = 5; // ç¨é‡‘èª¿æ•´ã®ãŸã‚ã®è©¦è¡Œå›æ•°åˆ¶é™

            // 1. ç¨é‡‘ã‚’è¦‹è¶Šã—ãŸç›®æ¨™å£²å´ç·é¡ã®æ±ºå®š
            for (let sellTrial = 0; sellTrial < MAX_SELL_TRIALS; sellTrial++) {
                let totalGrossSaleAmount = 0;
                let calculatedTax = 0;

                const totalCurrentAssets = currentStocks.reduce((sum, s) => sum + (s.Kuchisu * (s.CurrentValuePerUnit / s.Tani)), 0);
                if (totalCurrentAssets <= 0) break;

                const targetSaleRatio = totalCurrentAssets > 0 ? requiredSaleProceeds / totalCurrentAssets : 0;

                for (const stock of currentStocks) {
                    const { CurrentValuePerUnit, AveragePrice, Tani, Kuchisu, TaxStartYear, TaxStartMonth } = stock;

                    const taxStartMonthIndex = TaxStartYear * 12 + (TaxStartMonth === 0 ? 0 : TaxStartMonth - 1);
                    const isTaxable = (TaxStartYear === null || TaxStartMonth === null) ? false :
                        ((TaxStartYear === 0 && (TaxStartMonth === 0 || TaxStartMonth === 1)) || monthIndex >= taxStartMonthIndex);
                    const hasProfit = CurrentValuePerUnit > AveragePrice;

                    const currentStockValue = Kuchisu * (CurrentValuePerUnit / Tani);
                    let targetSaleValue = currentStockValue * targetSaleRatio;
                    let actualKuchisuToSell = Math.ceil(targetSaleValue / (CurrentValuePerUnit / Tani));
                    actualKuchisuToSell = Math.min(Kuchisu, Math.max(0, actualKuchisuToSell));

                    const saleProceedsBeforeTax = actualKuchisuToSell * (CurrentValuePerUnit / Tani);
                    totalGrossSaleAmount += saleProceedsBeforeTax;

                    if (isTaxable && hasProfit && actualKuchisuToSell > 0) {
                        const profit = actualKuchisuToSell * ((CurrentValuePerUnit - AveragePrice) / Tani);
                        calculatedTax += profit * trialCurrentTaxRate;
                    }
                }

                taxPayment = calculatedTax; // è©¦è¡Œã§è¨ˆç®—ã•ã‚ŒãŸç¨é¡
                const netSaleProceeds = totalGrossSaleAmount - taxPayment;

                if (netSaleProceeds >= netSaleAmountNeeded) {
                    requiredSaleProceeds = totalGrossSaleAmount; // å¿…è¦ãªå£²å´ç·é¡ãŒç¢ºå®š
                    break;
                } else {
                    requiredSaleProceeds = (netSaleAmountNeeded + taxPayment); // ç›®æ¨™å£²å´ç·é¡ã‚’å¢—ã‚„ã—ã¦å†è©¦è¡Œ
                    if (totalCurrentAssets < requiredSaleProceeds) {
                        requiredSaleProceeds = totalCurrentAssets;
                        break;
                    }
                }
            }

            // 2. æœ€çµ‚å£²å´å‡¦ç†
            const finalTotalAssets = currentStocks.reduce((sum, s) => sum + (s.Kuchisu * (s.CurrentValuePerUnit / s.Tani)), 0);
            const finalTargetSaleRatio = finalTotalAssets > 0 ? requiredSaleProceeds / finalTotalAssets : 0;
            sellProceeds = 0;

            for (const stock of currentStocks) {
                const { CurrentValuePerUnit, Tani, Kuchisu } = stock;
                if (Kuchisu === 0) continue;

                const currentStockValue = Kuchisu * (CurrentValuePerUnit / Tani);
                let targetSaleValue = currentStockValue * finalTargetSaleRatio;
                let actualKuchisuToSell = Math.ceil(targetSaleValue / (CurrentValuePerUnit / Tani));
                actualKuchisuToSell = Math.min(Kuchisu, Math.max(0, actualKuchisuToSell));

                const saleProceedsBeforeTax = actualKuchisuToSell * (CurrentValuePerUnit / Tani);
                sellProceeds += saleProceedsBeforeTax;
                stock.Kuchisu -= actualKuchisuToSell;
            }

            const netSaleProceeds = sellProceeds - taxPayment;

            if (netSaleProceeds >= requiredExpense) {
                const surplusCash = netSaleProceeds - requiredExpense;
                currentCash += Math.floor(surplusCash); // ä½™å‰°é‡‘ã‚’ç¾é‡‘ã«è¿½åŠ 
            } else {
                fireFailure = true;
            }

            return { currentCash, taxPayment, sellProceeds, fireFailure };
        }

        /**
         * éŠ˜æŸ„ã®åˆ©ç‡å¤‰å‹•ã‚’é©ç”¨ã—ã€æœˆæœ«ã®è³‡ç”£é¡ã¨è©³ç´°ã‚’è¨ˆç®—ã™ã‚‹
         */
        function applyMonthlyReturn(monthIndex, currentStocks, L, trialCurrentTaxRate) {
            const numStocks = currentStocks.length;
            const standardNormals = Array(numStocks).fill(0).map(() => numeric.random.normal());
            const Y = numeric.dot(L, standardNormals.map(n => [n]));
            const stockDetails = [];
            let endOfPeriodAssets = 0;

            for (let i = 0; i < numStocks; i++) {
                const stock = currentStocks[i];

                if (stock.Kuchisu <= 0) {
                    stockDetails.push({ rate: 0, value: 0, kuchisu: 0, currentValuePerUnit: 0, averagePrice: stock.AveragePrice, taxPerUnit: 0 });
                    continue;
                }

                // åˆ©ç‡å¤‰å‹•è¨ˆç®—
                const monthlyVolatility = stock.Volatility / 100 / Math.sqrt(12);
                const monthlyReturn = stock.Return / 100 / 12;
                const correlatedZ = Y[i][0];

                //ãã®æœˆã®ãã®éŠ˜æŸ„ã«é©ç”¨ã™ã‚‹ã€åˆ©ç‡ã‚’è¨ˆç®—ã™ã‚‹
                const monthlyRate = Math.exp(
                    (monthlyReturn - monthlyVolatility * monthlyVolatility / 2) +
                    (monthlyVolatility * correlatedZ)
                ) - 1;

                // å˜ä½å£æ•°å½“ãŸã‚Šã®æ–°ã—ã„ä¾¡é¡ã«æ›´æ–°
                stock.CurrentValuePerUnit *= (1 + monthlyRate);

                // æ–°ã—ã„é‡‘èè³‡ç”£é¡
                const currentValuePerUnit = stock.CurrentValuePerUnit;
                const pricePerUnit = currentValuePerUnit / stock.Tani;
                const financialAssetValue = stock.Kuchisu * pricePerUnit;
                endOfPeriodAssets += financialAssetValue;

                // è¡¨ç¤ºç”¨ç¨é¡ã®è¨ˆç®—
                let taxPerUnit = 0;
                const taxStartMonthIndex = stock.TaxStartYear * 12 + (stock.TaxStartMonth === 0 ? 0 : stock.TaxStartMonth - 1);
                const isTaxable = (stock.TaxStartYear === null || stock.TaxStartMonth === null) ? false :
                    ((stock.TaxStartYear === 0 && (stock.TaxStartMonth === 0 || stock.TaxStartMonth === 1)) || monthIndex >= taxStartMonthIndex);

                if (isTaxable && currentValuePerUnit > stock.AveragePrice) {
                    const profitPerUnit = (currentValuePerUnit - stock.AveragePrice) / stock.Tani;
                    taxPerUnit = profitPerUnit * trialCurrentTaxRate;
                }

                stockDetails.push({
                    rate: monthlyRate * 100, // %è¡¨ç¤º
                    value: financialAssetValue,
                    kuchisu: stock.Kuchisu,
                    currentValuePerUnit: currentValuePerUnit,
                    averagePrice: stock.AveragePrice,
                    taxPerUnit: taxPerUnit
                });
            }

            return { stockDetails, endOfPeriodAssets };
        }

        /**
         * ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­ãƒ»ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•°
         */
        function runMonteCarloSimulation(appData) {
            debugOutput('--- ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ ---');
            const config = appData.config;
            const stocks = appData.stocks;
            const totalPeriods = config.period * 12;
            const numTrials = config.times;
            const numStocks = stocks.length;
            const meigaraNames = stocks.map(s => s.Meigara);

            if (numStocks === 0) return [];


            // ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™: ç›¸é–¢è¡Œåˆ—Rã¨ã‚³ãƒ¬ã‚¹ã‚­ãƒ¼åˆ†è§£L
            const R = numeric.identity(numStocks);
            appData.soukan.forEach(item => {
                const indexA = meigaraNames.indexOf(item.A_Meigara);
                const indexB = meigaraNames.indexOf(item.B_Meigara);
                if (indexA !== -1 && indexB !== -1) {
                    R[indexA][indexB] = item.keisu;
                    R[indexB][indexA] = item.keisu;
                }
            });

            let L;
            try {
                L = numeric.cholesky(R);
            } catch (error) {
                debugOutput('ã‚¨ãƒ©ãƒ¼: ã‚³ãƒ¬ã‚¹ã‚­ãƒ¼åˆ†è§£ã«å¤±æ•—ã—ã¾ã—ãŸã€‚' + error.message);
		alert('ã‚¨ãƒ©ãƒ¼: ã‚³ãƒ¬ã‚¹ã‚­ãƒ¼åˆ†è§£ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nè¨­å®šã•ã‚ŒãŸç›¸é–¢ä¿‚æ•°ã«ã€Œæ•°å­¦çš„ãªçŸ›ç›¾ï¼ˆä¸€è²«æ€§ã®æ¬ å¦‚ï¼‰ã€ãŒç”Ÿã˜ã¦ã„ã‚‹å ´åˆã«ç™ºç”Ÿã—ã¾ã™ã€‚\n\nç›¸é–¢ä¿‚æ•°ã®è¨­å®šãŒè«–ç†çš„ã«ä¸€è²«ã—ã¦ã„ã‚‹ã‹ (ä¾‹: è¤‡æ•°ã®éŠ˜æŸ„é–“ã§ç›¸é–¢ä¿‚æ•°ãŒçŸ›ç›¾ã—ã¦ã„ãªã„ã‹) ã”ç¢ºèªãã ã•ã„ã€‚\nãŸãã•ã‚“ã‚ã‚‹ã¨ã€é›£ã—ã„ã§ã™ã‚ˆã­ğŸ˜…' + error.message);
                return [];
            }
            debugOutput('ã‚³ãƒ¬ã‚¹ã‚­ãƒ¼åˆ†è§£å®Œäº†ã€‚');

            const inflationRate = config.inflationRate / 100; // configã‹ã‚‰å–å¾—ã—ãŸ%ã‚’å°æ•°ã«å¤‰æ›
            // LifeCostã‚¤ãƒ™ãƒ³ãƒˆã‚’æœˆæ•°é †ã«ã‚½ãƒ¼ãƒˆ
            const lifeCostEvents = appData.lifeCost.sort((a, b) => a.month - b.month);
            let lifeCostEventIndex = -1;

            // 1. åˆæœŸç”Ÿæ´»è²»ã®ç‰¹å®š (month=0ã¾ãŸã¯æœ€ã‚‚æ—©ãç™ºç”Ÿã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆ)
            let currentMonthlyLifeCost = 0;
            if (lifeCostEvents.length > 0) {
                const initialLifeCostEvent = lifeCostEvents.find(lc => lc.month === 0);

                if (initialLifeCostEvent) {
                    // 0ãƒ¶æœˆç›®ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Œã°ãã‚Œã‚’åˆæœŸå€¤ã¨ã™ã‚‹
                    currentMonthlyLifeCost = initialLifeCostEvent.amount;
                    lifeCostEventIndex = lifeCostEvents.indexOf(initialLifeCostEvent);
                } else {
                    // 0ãƒ¶æœˆã®ã‚¤ãƒ™ãƒ³ãƒˆãŒãªã„å ´åˆã¯ã€è¨­å®šãŒãªã„ã¨ã¿ãªã— 0 å††ã¨ã™ã‚‹
                    currentMonthlyLifeCost = 0;
                }
            } else {
                // lifeCostã®è¨­å®šè‡ªä½“ãŒãªã„å ´åˆã¯0å††
                currentMonthlyLifeCost = 0;
            }

            // lifeCostEventIndexãŒ-1ã®å ´åˆã€0ç•ªç›®ã®è¦ç´ ã‚’æŒ‡ã™ã‚ˆã†ã«èª¿æ•´ã™ã‚‹
            if (lifeCostEventIndex === -1 && lifeCostEvents.length > 0) {
                // ãŸã¨ãˆæœˆãŒ0ã§ãªãã¦ã‚‚ã€æœ€åˆã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’èµ·ç‚¹ã¨ã—ã¦ãŠã
                lifeCostEventIndex = 0;
                currentMonthlyLifeCost = lifeCostEvents[0].amount;
            }

            const simulationResults = [];

            // å…¨è©¦è¡Œå›æ•°ã‚’ãƒ«ãƒ¼ãƒ—
            for (let t = 0; t < numTrials; t++) {

                let lifeCostEventIndex = -1;
                let currentMonthlyLifeCost = 0;

                if (lifeCostEvents.length > 0) {
                    const initialLifeCostEvent = lifeCostEvents.find(lc => lc.month === 0);
                    if (initialLifeCostEvent) {
                        currentMonthlyLifeCost = initialLifeCostEvent.amount;
                        lifeCostEventIndex = lifeCostEvents.indexOf(initialLifeCostEvent);
                    } else {
                        currentMonthlyLifeCost = 0;
                    }
                } else {
                    currentMonthlyLifeCost = 0;
                }

                if (lifeCostEventIndex === -1 && lifeCostEvents.length > 0) {
                    lifeCostEventIndex = 0;
                    currentMonthlyLifeCost = lifeCostEvents[0].amount;
                }


                let currentCash = config.cash; // (6) ä¿æœ‰ç¾é‡‘ (åˆæœŸå€¤)
                // éŠ˜æŸ„ã®åˆæœŸçŠ¶æ…‹ã‚’ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼
                const currentStocks = stocks.map(s => ({
                    ...s,
                    Kuchisu: s.Kuchisu,
                    CurrentValuePerUnit: s.CurrentValuePerUnit,
                    AveragePrice: s.AveragePrice,
                }));
                let fireFailure = false;
                let failureMonth = -1; // å¤±æ•—ãŒç¢ºå®šã—ãŸæœˆæ•° (0ãƒ™ãƒ¼ã‚¹) ã‚’è¨˜éŒ²
                const history = [];

                // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æœŸé–“ã‚’æœˆã”ã¨ã«ãƒ«ãƒ¼ãƒ—
                for (let monthIndex = 0; monthIndex < totalPeriods; monthIndex++) {

                    if (fireFailure) break;
                    const yearMonthStr = `${Math.floor(monthIndex / 12)}å¹´${(monthIndex % 12) + 1}æœˆ`;

                    const transferAssets = monthIndex === 0 ?
                        stocks.reduce((sum, s) => sum + (s.Kuchisu / s.Tani * s.CurrentValuePerUnit), 0) :
                        history[monthIndex - 1].endOfPeriodAssets;

                    // 1. æœˆæ¬¡ç¨ç‡ã®æ±ºå®š
                    const trialCurrentTaxRate = calculateTaxRate(monthIndex, appData.tax);

                    // 1. æœˆæ¬¡ã‚¤ãƒ³ãƒ•ãƒ¬ã¨ãƒ©ã‚¤ãƒ•ã‚³ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆã®ãƒã‚§ãƒƒã‚¯
                    let lifeCostReset = false;

                    // LifeCostã‚¤ãƒ™ãƒ³ãƒˆã®åˆ‡ã‚Šæ›¿ã‚ã‚Šãƒã‚§ãƒƒã‚¯ (æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒã“ã®æœˆã«ç™ºç”Ÿã™ã‚‹ã‹)
                    if (lifeCostEventIndex + 1 < lifeCostEvents.length) {
                        const nextEvent = lifeCostEvents[lifeCostEventIndex + 1];
                        if (monthIndex === nextEvent.month) {
                            // AæœŸé–“ã‹ã‚‰BæœŸé–“ã¸ã®åˆ‡æ›¿: BæœŸé–“ã®äºˆå®šå‡ºè²»ï¼ˆnextEvent.amountï¼‰ã‚’åŸºæº–ã«ãƒªã‚»ãƒƒãƒˆ
                            // ã‚¤ãƒ³ãƒ•ãƒ¬çµæœã«é–¢ã‚ã‚‰ãšã€BæœŸé–“ã®åŸºæº–å€¤ã§å†ã‚¹ã‚¿ãƒ¼ãƒˆã™ã‚‹
                            currentMonthlyLifeCost = nextEvent.amount;
                            lifeCostEventIndex++;
                            lifeCostReset = true;
                        }
                    }
                    // æ¯å¹´1æœˆï¼ˆmonthIndexãŒ12ã§å‰²ã‚Šåˆ‡ã‚Œã‚‹ã€ã‹ã¤0ãƒ¶æœˆç›®ã§ã¯ãªã„ï¼‰ã«ã‚¤ãƒ³ãƒ•ãƒ¬ã‚’é©ç”¨
                    // monthIndex 12, 24, 36, ... ãŒ 1æœˆï¼ˆçµŒé1å¹´å¾Œã€2å¹´å¾Œ...ã®1æœˆï¼‰
                    if (monthIndex > 0 && monthIndex % 12 === 0 && !lifeCostReset) {
                        currentMonthlyLifeCost *= (1 + inflationRate);
                    }
                    const monthlyLifeCostForSimulation = currentMonthlyLifeCost;


                    // 2. åå…¥ã¨å‡ºè²»ã®å‡¦ç† (è¿½åŠ æŠ•è³‡ãƒ»å£²å´å‰ã®ç¾é‡‘æ®‹é«˜ã¨ä¸è¶³é¡ã‚’è¨ˆç®—)
                    const { currentCash: cashAfterIncomeExpense, monthlyIncome, totalExpense, requiredAssetSale } = handleIncomeAndExpense(
                        monthIndex,
                        currentCash,
                        appData,
                        monthlyLifeCostForSimulation // ã‚¤ãƒ³ãƒ•ãƒ¬é©ç”¨æ¸ˆã¿å‡ºè²»ã‚’æ¸¡ã™
                    );
                    currentCash = cashAfterIncomeExpense;
                    let requiredExpense = requiredAssetSale;

                    // 3. è¿½åŠ æŠ•è³‡å‡¦ç†
                    const tuikaResult = handleTuikaInvestment(monthIndex, currentCash, currentStocks, appData, meigaraNames);
                    currentCash = tuikaResult.currentCash;

                    // 4. é‡‘èè³‡ç”£ã®å£²å´ (ç¾é‡‘ä¸è¶³ã®å ´åˆ)
                    let taxPayment = 0;
                    if (requiredExpense > 0) {
                        const saleResult = handleAssetSale(requiredExpense, currentCash, currentStocks, trialCurrentTaxRate, monthIndex);
                        currentCash = saleResult.currentCash;
                        taxPayment = saleResult.taxPayment;
                        fireFailure = saleResult.fireFailure;
                        if (fireFailure) {
                            failureMonth = monthIndex; //ã“ã“ã§å¤±æ•—æœˆæ•°ã‚’è¨˜éŒ²
                            debugOutput(`è³‡ç”£æ¯æ¸‡ã«ã‚ˆã‚ŠFIREå¤±æ•— (${yearMonthStr})`);
                        }
                    }

                    // 5. åˆ©ç‡å¤‰å‹•
                    const returnResult = applyMonthlyReturn(monthIndex, currentStocks, L, trialCurrentTaxRate);
                    const endOfPeriodAssets = returnResult.endOfPeriodAssets;
                    const stockDetails = returnResult.stockDetails;

                    // 6. è³‡ç”£æ¯æ¸‡ã®ç¢ºèª (ç·è³‡ç”£)
                    const totalAsset = endOfPeriodAssets + currentCash;
                    if (totalAsset < 0) {
                        fireFailure = true;
                        failureMonth = monthIndex; //ã“ã“ã§å¤±æ•—æœˆæ•°ã‚’è¨˜éŒ²
                    }

                    // æœˆæ¬¡å±¥æ­´ã‚’è¨˜éŒ²
                    history.push({
                        yearMonth: yearMonthStr,
                        transferAssets: transferAssets, // (2) å¼•ç¶™é‡‘èè³‡ç”£é¡
                        expense: totalExpense, // (3) å‡ºè²» â† expenseResult.totalExpense ã‚’ totalExpense ã«å¤‰æ›´
                        income: monthlyIncome, // (4) åå…¥ â† expenseResult.monthlyIncome ã‚’ monthlyIncome ã«å¤‰æ›´
                        tax: taxPayment, // (5) ç¨é‡‘
                        cash: currentCash, // (6) ä¿æœ‰ç¾é‡‘ (æœˆæœ«æ®‹é«˜)
                        tuika: tuikaResult.monthlyTuikaInvestment, // (7) è¿½åŠ æŠ•è³‡
                        endOfPeriodAssets: endOfPeriodAssets, // (8) æœŸæœ«é‡‘èè³‡ç”£é¡
                        totalAsset: totalAsset, // (9) ç·è³‡ç”£
                        stockDetails: stockDetails,
                        isFailure: fireFailure
                    });
                }

                simulationResults.push({
                    trialId: t + 1,
                    success: !fireFailure,
                    failureMonth: fireFailure ? failureMonth : totalPeriods,
                    history: history
                });
                debugOutput(`è©¦è¡Œ #${t + 1} å®Œäº†ã€‚æˆåŠŸ: ${!fireFailure}`);

            }

            debugOutput('--- ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº† ---');
            return simulationResults;
        }

        // --- ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­ãƒ»ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ çµ‚äº† ---

        //ãƒãƒ£ãƒ¼ãƒˆç”Ÿæˆç”¨
        let totalAssetChartInstance = null;
	let currentActiveButton = null;

        // ... (DOMæ“ä½œã¨è¡¨ç¤ºåˆ¶å¾¡ã®ã‚³ãƒ¼ãƒ‰ã¯å¤‰æ›´ãªã—) ...
        document.addEventListener('DOMContentLoaded', () => {
            const simulationButtonsDiv = document.getElementById('simulation-buttons');
            const summaryText = document.getElementById('summary-text');
            const detailSection = document.getElementById('simulation-detail');
            const detailTitle = document.getElementById('detail-title');
            const detailTableBody = document.getElementById('detail-table-body');
            const failureFilter = document.getElementById('failure-filter');
            const meigaraLegend = document.getElementById('meigara-legend');
            const headerRow1 = document.getElementById('header-row-1');
            const headerRow2 = document.getElementById('header-row-2');

		//ã‚°ãƒ©ãƒ•ã®é ˜åŸŸ
	    const dynamicChartContainer = document.getElementById('dynamic-chart-container');
	    const totalAssetChart = document.getElementById('totalAssetChart');


            let simulationResults = [];
            let currentTrialIndex = -1;
            let meigaraNames = [];

            /**
             * éŠ˜æŸ„ã”ã¨ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚»ãƒ«ã‚’å‹•çš„ã«ç”Ÿæˆã™ã‚‹
             * @param {Array} stocks - éŠ˜æŸ„æƒ…å ±ã®é…åˆ—
             */
            function setupTableHeader(stocks) {
                let child = headerRow1.lastElementChild;
                while (child && child.id !== 'header-row-1-month') {
                    if (headerRow1.children.length > 1) {
                        headerRow1.removeChild(headerRow1.lastElementChild);
                    } else {
                        break;
                    }
                    child = headerRow1.lastElementChild;
                }

                while (headerRow2.children.length > 9) {
                    headerRow2.removeChild(headerRow2.lastChild);
                }

                meigaraNames = stocks.map(s => s.Meigara);

                // éŠ˜æŸ„ã®æ•°ã ã‘ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ 
                stocks.forEach((stock, index) => {
                    // 1è¡Œç›®: éŠ˜æŸ„å
                    const th1 = document.createElement('th');
                    th1.colSpan = "4";
                    th1.textContent = `éŠ˜æŸ„${String.fromCharCode(65 + index)}`

                    //éŠ˜æŸ„ãƒ˜ãƒƒãƒ€ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºå‹•ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚	è¿½åŠ é–‹å§‹
                    th1.classList.add('meigara-header-group');
                    th1.dataset.meigaraIndex = index; // 0, 1, 2, ... ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
                    //éŠ˜æŸ„ãƒ˜ãƒƒãƒ€ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºå‹•ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚	è¿½åŠ çµ‚äº†

                    headerRow1.appendChild(th1);

                    // 2è¡Œç›®: è©³ç´°é …ç›® (4ã¤ã®ã‚»ãƒ«)
                    const th2_rate = document.createElement('th');
                    th2_rate.textContent = 'åˆ©ç‡ï¼…';
                    headerRow2.appendChild(th2_rate);

                    const th2_value = document.createElement('th');
                    th2_value.textContent = 'è³‡ç”£é¡';
                    headerRow2.appendChild(th2_value);

                    const th2_kuchisu = document.createElement('th');
                    th2_kuchisu.textContent = 'ä¿æœ‰å£æ•°';
                    headerRow2.appendChild(th2_kuchisu);

                    const th2_price = document.createElement('th');
                    th2_price.innerHTML = 'ç¾åœ¨/<br>å¹³å‡<br>(ç¨é¡/1å£)';
                    headerRow2.appendChild(th2_price);
                });

                // 1è¡Œç›®ã®å…±é€šé …ç›®ã®ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆæœˆæ¬¡åæ”¯ãƒ»è³‡ç”£ç·é¡ï¼‰ã‚’å‹•çš„ã«è¿½åŠ 
                const th1_common = document.createElement('th');
                th1_common.colSpan = "8";
                th1_common.textContent = 'æœˆæ¬¡åæ”¯ãƒ»è³‡ç”£ç·é¡';
                headerRow1.insertBefore(th1_common, headerRow1.children[1]);

                // å‡¡ä¾‹ã®è¨­å®š
                const legendHtml = '<h3>å‡¡ä¾‹</h3>';
                meigaraLegend.innerHTML = legendHtml + stocks.map((s, i) =>
                    `éŠ˜æŸ„${String.fromCharCode(65 + i)}: ${s.Meigara}`
                ).join('<br>') + '<BR><BR>â€»ã€€ãƒ†ãƒ¼ãƒ–ãƒ«ã®éŠ˜æŸ„Aã€éŠ˜æŸ„Bãƒ»ãƒ»ãƒ»ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€å¹…ã‚’ç¸®ã‚ãŸã‚Šåºƒã’ãŸã‚Šã§ãã¾ã™ã€‚<br>';
            }


            /**
             * ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«ã«çµæœã‚’è¡¨ç¤º
             * @param {number} trialIndex - è¡¨ç¤ºã™ã‚‹è©¦è¡Œã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
             * @param {HTMLElement} clickedButton - ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒœã‚¿ãƒ³è¦ç´  â† â˜…â˜…â˜… ã“ã®è¡Œã‚’è¿½åŠ  â˜…â˜…â˜…
             */
            function displaySimulationDetail(trialIndex, clickedButton) {
                currentTrialIndex = trialIndex;
                const result = simulationResults[trialIndex];
                const history = result.history;

                detailTitle.textContent = `ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è©³ç´°ï¼ˆè©¦è¡Œ #${result.trialId} - ${result.success ? 'æˆåŠŸ' : 'å¤±æ•—'}ï¼‰`;
                detailTableBody.innerHTML = ''; // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã‚¯ãƒªã‚¢

                history.forEach((entry, historyIndex) => {
                    const row = detailTableBody.insertRow();

                    // (1) å¹´æœˆ
                    let rowHtml = `<td class="text-left">${entry.yearMonth}</td>`;

                    // (2) å¼•ç¶™é‡‘èè³‡ç”£é¡ 
                    let transferAssets = entry.transferAssets;
                    rowHtml += `<td>${window.formatNumber(transferAssets)}</td>`;

                    // (3) å‡ºè²» - æ‰‹å–ã‚Šã¨ã—ã¦å¿…è¦ãªé‡‘é¡ 
                    rowHtml += `<td>${window.formatNumber(entry.expense)}</td>`;
                    // (4) åå…¥
                    rowHtml += `<td>${window.formatNumber(entry.income)}</td>`;
                    // (5) ç¨é‡‘
                    rowHtml += `<td>${window.formatNumber(entry.tax)}</td>`;
                    // (6) ä¿æœ‰ç¾é‡‘
                    rowHtml += `<td>${window.formatNumber(entry.cash)}</td>`;
                    // (7) è¿½åŠ æŠ•è³‡
                    rowHtml += `<td>${window.formatNumber(entry.tuika)}</td>`;

                    // (8) æœŸæœ«é‡‘èè³‡ç”£é¡ - ( )ã‚’ã¤ã‘ãŸå¯¾å‰æœˆæ¯”ã®å·®ã‚’è¨˜è¼‰

                    const investmentChange = entry.endOfPeriodAssets - (entry.transferAssets + entry.tuika);

                    const assetChangeText = `${window.formatNumber(entry.endOfPeriodAssets)}<br>(${window.formatNumber(investmentChange)})`;
                    rowHtml += `<td>${assetChangeText}</td>`;

                    // (9) ç·è³‡ç”£
                    rowHtml += `<td>${window.formatNumber(entry.totalAsset)}</td>`;

                    // éŠ˜æŸ„ã”ã¨ã®è³‡ç”£é¡ã®è¡¨ç¤º
                    entry.stockDetails.forEach((stock, stockIndex) => {
                        const initialStockData = window.appData.stocks[stockIndex];

                        // *ä¿æœ‰å£æ•°ã®æ®‹æ•°ï¼ˆã‚»ãƒ«ï¼‰*
                        const prevStockKuchisu = historyIndex === 0 ? initialStockData.Kuchisu : history[historyIndex - 1].stockDetails[stockIndex].kuchisu;
                        const kuchisuChange = stock.kuchisu - prevStockKuchisu;
                        const kuchisuChangeText = kuchisuChange > 0 ? `<span class="kuchisu-increase">(+${window.formatNumber(kuchisuChange)})</span>` : `(${window.formatNumber(kuchisuChange)})`;
                        const kuchisuCell = `${window.formatNumber(stock.kuchisu)}<br>${kuchisuChangeText}`;

                        // *ç¾åœ¨ä¾¡é¡/å¹³å‡å–å¾—ä¾¡é¡ï¼ˆã‚»ãƒ«ï¼‰*
                        const currentValuePerUnit = stock.currentValuePerUnit;
                        const averagePrice = stock.averagePrice;
                        const priceLine = `${window.formatNumber(currentValuePerUnit)}/${window.formatNumber(averagePrice)}`;

                        const taxPerUnitText = stock.taxPerUnit > 0.0000001 ? `(${stock.taxPerUnit.toFixed(4)}å††/å£)` : `ç„¡ç¨`;

                        const priceCell = `${priceLine}<br>${taxPerUnitText}`;

                        // ã‚»ãƒ«ã‚’è¿½åŠ 
                        rowHtml += `
                            <td>${stock.rate.toFixed(2)}%</td>
                            <td>${window.formatNumber(stock.value)}</td>
                            <td>${kuchisuCell}</td>
                            <td>${priceCell}</td>
                        `;
                    });

                    row.innerHTML = rowHtml;
                    detailTableBody.appendChild(row);
                });

                detailSection.style.display = 'block';


		// --- ã‚°ãƒ©ãƒ•è¡¨ç¤ºä½ç½®ã®å‹•çš„å¤‰æ›´ ---
		// ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã®ç›´å¾Œã«ã‚°ãƒ©ãƒ•ã‚³ãƒ³ãƒ†ãƒŠã‚’ç§»å‹•
		clickedButton.after(dynamicChartContainer);
		dynamicChartContainer.style.display = 'block';	 // ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤º

                //ã‚°ãƒ©ãƒ•æç”»ãƒ­ã‚¸ãƒƒã‚¯ã®è¿½åŠ 
                const labels = history.map(entry => entry.yearMonth);
                const data = history.map(entry => entry.totalAsset);

                 const ctx = totalAssetChart.getContext('2d'); // totalAssetChart ã‚’ä½¿ç”¨

                // æ—¢å­˜ã®ã‚°ãƒ©ãƒ•ãŒã‚ã‚Œã°ç ´æ£„ã—ã¦æ–°ã—ã„æç”»ã«å‚™ãˆã‚‹
                if (totalAssetChartInstance) {
                    totalAssetChartInstance.destroy();
                }

                // æ–°ã—ã„æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ã‚’ä½œæˆ
                totalAssetChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            // 1. ç·è³‡ç”£ã®æ¨ç§» (ãƒªãƒ‹ã‚¢è»¸ - å·¦)
                            {
                                label: '(9) ç·è³‡ç”£ã®æ¨ç§» (ãƒªãƒ‹ã‚¢)',
                                data: data,
                                borderColor: result.success ? '#3498db' : '#e74c3c', // æˆåŠŸ:é’, å¤±æ•—:èµ¤
                                backgroundColor: result.success ? 'rgba(52, 152, 219, 0.1)' : 'rgba(231, 76, 60, 0.1)',
                                borderWidth: 2,
                                pointRadius: 0,
                                tension: 0.1,
                                fill: true,
                                yAxisID: 'y' // å·¦å´ã®ãƒªãƒ‹ã‚¢è»¸ã‚’ä½¿ç”¨
                            },
                            // 2. ç·è³‡ç”£ã®æ¨ç§» (å¯¾æ•°è»¸ - å³)
                            {
                                label: '(9) ç·è³‡ç”£ã®æ¨ç§» (å¯¾æ•°)',
                                data: data,
                                borderColor: '#2ecc71', // ç·‘è‰²ã«å¤‰æ›´
                                backgroundColor: 'transparent', // å¡—ã‚Šã¤ã¶ã—ãªã—
                                borderWidth: 2,
                                pointRadius: 0,
                                tension: 0.1,
                                fill: false, // å¡—ã‚Šã¤ã¶ã—ãªã—
                                yAxisID: 'y1', // æ–°ã—ã„å¯¾æ•°è»¸ã‚’ä½¿ç”¨
                                borderDash: [5, 5] // ç ´ç·šã«ã™ã‚‹ãªã©ã—ã¦åŒºåˆ¥ã—ã‚„ã™ãã™ã‚‹
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `è©¦è¡Œ #${result.trialId} ã®ç·è³‡ç”£ã®æ¨ç§» (${result.success ? 'æˆåŠŸ' : 'å¤±æ•—'})`
                            },
                            legend: {
                                display: true, // å‡¡ä¾‹ã‚’è¡¨ç¤ºã—ã¦2ã¤ã®ã‚°ãƒ©ãƒ•ã‚’åŒºåˆ¥
                                position: 'top',
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'æœŸé–“'
                                },
                                ticks: {
                                    autoSkip: true,
                                    maxTicksLimit: 20
                                }
                            },
                            // å·¦å´ã®Yè»¸ (ãƒªãƒ‹ã‚¢)
                            y: {
                                type: 'linear', // æ˜ç¤ºçš„ã«ãƒªãƒ‹ã‚¢ã‚’è¨­å®š
                                position: 'left', // å·¦å´ã«é…ç½®
                                title: {
                                    display: true,
                                    text: 'ç·è³‡ç”£é¡ (ãƒªãƒ‹ã‚¢ã‚¹ã‚±ãƒ¼ãƒ«)'
                                },
                                beginAtZero: false,
                                ticks: {
                                    // è»¸ã®ç›®ç››ã‚Šã‚’åˆ†ã‹ã‚Šã‚„ã™ããƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                                    callback: function (value) {
                                        return window.formatNumber(value);
                                    }
                                }
                            },
                            // å³å´ã®Yè»¸ (å¯¾æ•°)
                            y1: {
                                type: 'logarithmic', // å¯¾æ•°ã‚¹ã‚±ãƒ¼ãƒ«ã‚’è¨­å®š
                                position: 'right', // å³å´ã«é…ç½®
                                title: {
                                    display: true,
                                    text: 'ç·è³‡ç”£é¡ (å¯¾æ•°ã‚¹ã‚±ãƒ¼ãƒ«)'
                                },
                                grid: {
                                    drawOnChartArea: false, // ã‚°ãƒ©ãƒ•é ˜åŸŸã«ç·šã‚’å¼•ã‹ãªã„
                                },
                                ticks: {
                                    callback: function (value) {
                                        // å¯¾æ•°è»¸ã¯ç›®ç››ã‚Šã®å€¤ã‚’æ•´å½¢ã™ã‚‹ã®ã«ç‰¹åˆ¥ãªå‡¦ç†ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚‹
                                        if (value >= 10000000000) return window.formatNumber(value / 10000000000) + 'å…†';
                                        if (value >= 100000000) return window.formatNumber(value / 100000000) + 'å„„';
                                        if (value >= 10000) return window.formatNumber(value / 10000) + 'ä¸‡';
                                        return window.formatNumber(value);
                                    }
                                }
                            }
                        }
                    }
                });

		// --- ã‚°ãƒ©ãƒ•ã®ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®è¨­å®š ---
		totalAssetChart.ondblclick = () => {
			hideChart(); // æ–°ã—ã„éè¡¨ç¤ºé–¢æ•°ã‚’å‘¼ã³å‡ºã™
		};
		currentActiveButton = clickedButton; // æœ€å¾Œã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ãªã£ãŸãƒœã‚¿ãƒ³ã‚’è¨˜æ†¶

            }

	/**
	 * ã‚°ãƒ©ãƒ•ã‚’éè¡¨ç¤ºã«ã™ã‚‹é–¢æ•°
	 */
	function hideChart() {
		if (totalAssetChartInstance) {
			totalAssetChartInstance.destroy();
			totalAssetChartInstance = null;
		}
		dynamicChartContainer.style.display = 'none'; // ã‚°ãƒ©ãƒ•ã‚³ãƒ³ãƒ†ãƒŠã‚’éè¡¨ç¤º
		// æœ€å¾Œã«ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è§£é™¤ã—ãŸã„å ´åˆã¯ã“ã“ã§å‡¦ç†
		if (currentActiveButton) {
			currentActiveButton.classList.remove('active-chart-button');
			currentActiveButton = null;
		}
	}

            /**
             * ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°
             * @param {boolean} showFailuresOnly - å¤±æ•—ã‚±ãƒ¼ã‚¹ã®ã¿ã‚’è¡¨ç¤ºã™ã‚‹ã‹ã©ã†ã‹
             */
            function updateSimulationButtons(showFailuresOnly) {
                simulationButtonsDiv.innerHTML = '';

                simulationResults.forEach((result, index) => {
                    if (showFailuresOnly && result.success) return;

                    const button = document.createElement('button');
                    button.id = `result-${result.trialId}`;
                    button.className = `simulation-button ${result.success ? 'success' : 'failure'}`;
                    button.textContent = result.trialId;

                    button.addEventListener('click', () => {
				// åŒã˜ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚‰éè¡¨ç¤ºã«ã™ã‚‹
				if (currentActiveButton === event.currentTarget) {
					hideChart();
					return;
				}
				// æ—¢ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒœã‚¿ãƒ³ãŒã‚ã‚Œã°ã€ãã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è§£é™¤
				if (currentActiveButton) {
					currentActiveButton.classList.remove('active-chart-button');
				}
				// æ–°ã—ãã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã—ã€è©³ç´°ã‚’è¡¨ç¤º
				event.currentTarget.classList.add('active-chart-button');
				displaySimulationDetail(index, event.currentTarget); // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã‚’æ¸¡ã™
			});

                    simulationButtonsDiv.appendChild(button);
                });

                // æˆåŠŸ/å¤±æ•—ã®ã‚µãƒãƒªãƒ¼ã‚’æ›´æ–°
                const successCount = simulationResults.filter(r => r.success).length;
                const failureCount = simulationResults.length - successCount;
                const successRate = (simulationResults.length > 0 ? successCount / simulationResults.length * 100 : 0).toFixed(1);

                // 1. æˆåŠŸã‚±ãƒ¼ã‚¹ã®çµ±è¨ˆ (æœ€çµ‚ç·è³‡ç”£)
                const successfulFinalAssets = simulationResults
                    .filter(r => r.success)
                    .map(r => r.history[r.history.length - 1].totalAsset);

                let medianAsset = 0;
                let worst10thAsset = 0;

                if (successfulFinalAssets.length > 0) {
                    medianAsset = calculatePercentile(successfulFinalAssets, 50);
                    worst10thAsset = calculatePercentile(successfulFinalAssets, 10);
                }

                // 2. å¤±æ•—ã‚±ãƒ¼ã‚¹ã®çµ±è¨ˆ (æœ€çµ‚ç·è³‡ç”£ã¨å¤±æ•—æœˆæ•°)
                const failureFinalAssets = simulationResults
                    .filter(r => !r.success)
                    .map(r => r.history[r.history.length - 1].totalAsset);

                const failureMonths = simulationResults
                    .filter(r => !r.success)
                    .map(r => r.failureMonth + 1); // 0ãƒ™ãƒ¼ã‚¹ã®æœˆæ•°ã«+1ã—ã¦è¡¨ç¤ºæœˆæ•°ã«

                let medianFailureAsset = 0;
                let medianFailureMonth = 0;

                if (failureFinalAssets.length > 0) {
                    medianFailureAsset = calculatePercentile(failureFinalAssets, 50);

                    // å¤±æ•—ç¢ºå®šæœŸé–“ã®ä¸­å¤®å€¤ï¼ˆæœˆæ•°ï¼‰ã‚’è¨ˆç®—
                    medianFailureMonth = calculatePercentile(failureMonths, 50);
                }

                // 3. å…¨ä½“è©•ä¾¡ã®ç”Ÿæˆ
                const overallAssessment = generateOverallAssessment(parseFloat(successRate), worst10thAsset);

                // 4. ã‚µãƒãƒªãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã®æ›´æ–° (HTMLæ§‹é€ ã®å¤‰æ›´)
                // æœˆæ•°ã‚’ã€ŒXå¹´ Yãƒ¶æœˆã€å½¢å¼ã«å¤‰æ›ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
                const formatMonths = (months) => {
                    const totalMonths = Math.round(months);
                    if (totalMonths <= 0) return "é–‹å§‹æ™‚";
                    const years = Math.floor(totalMonths / 12);
                    const m = totalMonths % 12;
                    if (years > 0) {
                        return `${years}å¹´${m}ãƒ¶æœˆ`;
                    }
                    return `${m}ãƒ¶æœˆ`;
                };

                summaryText.innerHTML = `
			    <h2>å…¨ä½“è©•ä¾¡</h2>
			    <p style="font-size: 1.2em; font-weight: bold; color: #2980b9;">
			        ${overallAssessment}
			    </p>
			    <hr style="margin: 15px 0;">

			    **è©¦è¡Œå›æ•°:** ${simulationResults.length}å›<br>
			    **FIREæˆåŠŸç‡:** <span style="color:#3498db; font-size: 1.1em; font-weight: bold;">${successRate}%</span> (${successCount}å›)<br>
			    **FIREå¤±æ•—ç‡:** <span style="color:#e74c3c; font-size: 1.1em; font-weight: bold;">${(100 - successRate).toFixed(1)}%</span> (${failureCount}å›)
			    <hr style="margin: 10px 0;">

			    <div style="display: flex; justify-content: space-around; text-align: left; padding: 10px;">
			        <div style="padding-right: 15px; flex: 1;">
		            <h3>âœ… æˆåŠŸã‚±ãƒ¼ã‚¹ (æœ€çµ‚ç·è³‡ç”£äºˆæ¸¬)</h3>
		            <p>
		                <span style="font-weight: bold;">ä¸­å¤®å€¤ (50%ã‚¿ã‚¤ãƒ«):</span> ${window.formatNumber(Math.round(medianAsset))} å††<br>
		                <span style="font-weight: bold; color: #e67e22;">æ‚²è¦³çš„ãªã‚±ãƒ¼ã‚¹ (10%ã‚¿ã‚¤ãƒ«):</span> ${window.formatNumber(Math.round(worst10thAsset))} å††
		            </p>
		            <span style="font-size: 0.9em; display: block;">â€» 90%ã®ç¢ºç‡ã§ã€10%ã‚¿ã‚¤ãƒ«ä»¥ä¸Šã®è³‡ç”£ãŒæ®‹ã‚Šã¾ã™ã€‚</span>
			        </div>
        
			        <div style="border-left: 1px solid #ccc; padding-left: 15px; flex: 1;">
			            <h3>âŒ å¤±æ•—ã‚±ãƒ¼ã‚¹ (ãƒªã‚¹ã‚¯åˆ†æ)</h3>
			            <p>
			                <span style="font-weight: bold;">å¤±æ•—ã¾ã§ã®æœŸé–“ (ä¸­å¤®å€¤):</span> ${formatMonths(medianFailureMonth)}<br>
			                <span style="font-weight: bold; color: #c0392b;">çµ‚äº†æ™‚è³‡ç”£ (ä¸­å¤®å€¤):</span> ${window.formatNumber(Math.round(medianFailureAsset))} å††
			            </p>
			            <span style="font-size: 0.9em; display: block;">â€» å¤±æ•—ãƒªã‚¹ã‚¯ãŒç™ºç”Ÿã—ãŸå ´åˆã€ã“ã®æœŸé–“ã§è³‡ç”£ãŒæ¯æ¸‡ã™ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã§ã™ã€‚</span>
			        </div>
			    </div>
			`;

                // è©³ç´°è¡¨ç¤ºã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ¶å¾¡ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯
                if (currentTrialIndex !== -1) {
                    const currentResult = simulationResults[currentTrialIndex];

                    // è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹è©¦è¡ŒãŒã€ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆå¤±æ•—ã®ã¿ï¼‰ã§éè¡¨ç¤ºã«ãªã‚‹ã¹ãã‹ãƒã‚§ãƒƒã‚¯
                    if (currentResult && showFailuresOnly && currentResult.success) {
                        detailSection.style.display = 'none';
                    } else {
                        detailSection.style.display = 'block';
                    }
                }
            }



            /**
                 * é…åˆ—ã‹ã‚‰æŒ‡å®šã•ã‚ŒãŸãƒ‘ãƒ¼ã‚»ãƒ³ã‚¿ã‚¤ãƒ«å€¤ã‚’è¨ˆç®—ã™ã‚‹
                 * @param {Array<number>} data - æ•°å€¤ã®é…åˆ—
                 * @param {number} percentile - æ±‚ã‚ã‚‹ãƒ‘ãƒ¼ã‚»ãƒ³ã‚¿ã‚¤ãƒ« (0-100)
                 * @returns {number} ãƒ‘ãƒ¼ã‚»ãƒ³ã‚¿ã‚¤ãƒ«å€¤
                 */
            function calculatePercentile(data, percentile) {
                if (data.length === 0) return 0;
                const sortedData = [...data].sort((a, b) => a - b);
                const index = (percentile / 100) * (sortedData.length - 1);
                if (index % 1 === 0) {
                    return sortedData[index];
                } else {
                    const lower = Math.floor(index);
                    const upper = Math.ceil(index);
                    const weight = index - lower;
                    return sortedData[lower] * (1 - weight) + sortedData[upper] * weight;
                }
            }

            /**
                 * æˆåŠŸç‡ã¨æ‚²è¦³çš„ãªã‚±ãƒ¼ã‚¹ã®è³‡ç”£é¡ã«åŸºã¥ãã€ç·åˆçš„ãªè©•ä¾¡æ–‡ã‚’ç”Ÿæˆã™ã‚‹
                 */
            function generateOverallAssessment(successRate, worst10thAsset) {
                let assessment = "";

                if (successRate >= 99) {
                    stars = 'â­â­â­â­â­â­â­â­â­â­';
                    comment = `ã€è©•ä¾¡ï¼šFIREã—ã¡ã‚ƒã„ã¾ã™ã‹ï¼ã€‘ã‚‚ã†FIREã›ãšã«å¾Œæ‚”ã™ã‚‹äººç”Ÿã®ã»ã†ãŒãƒªã‚¹ã‚¯ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
				<br>è³‡ç”£ãŒæ¯æ¸‡ã—ãŸã‚‰é‹ãŒãªã‹ã£ãŸã¨è«¦ã‚ã‚‰ã‚Œã‚‹ãƒ¬ãƒ™ãƒ«ã§ã™ã€‚
				<br>ä¼šç¤¾å“¡ã®ã†ã¡ã«ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã®ä½œæˆã€ä½å®…ãƒ­ãƒ¼ãƒ³ã®åˆ©ç”¨ç­‰ã€ï¼¦ï¼©ï¼²ï¼¥å¾Œã§ã¯å¯©æŸ»ãŒé€šã‚‰ãªã„ã‚‚ã®ã‚’æ¸ˆã¾ã›ã¦ãŠãã®ã‚‚å¿˜ã‚Œãšã«ã€‚`;
                } else if (successRate >= 95) {
                    stars = 'â­â­â­â­â­';
                    comment = `ã€è©•ä¾¡ï¼šæ¥µã‚ã¦é«˜ã„ç¢ºå®Ÿæ€§ã€‘ã‚ãªãŸã®FIREè¨ˆç”»ã¯æ¥µã‚ã¦é«˜ã„ç¢ºå®Ÿæ€§ã‚’æŒã£ã¦ã„ã¾ã™ã€‚
				<br>è³‡ç”£ãŒæ¯æ¸‡ã™ã‚‹ç¢ºç‡ã¯éå¸¸ã«ä½ã„ã§ã™ã€‚
				<br>ãŸã ã—ã€çªç„¶ã®å¤§ããªå‡ºè²»ã€æ€¥æ¿€ãªç‰©ä¾¡é«˜ã€å¸‚å ´ã®é•·æœŸé–“åœæ»ãªã©ã®è¤‡æ•°ã®å±æ©ŸãŒé‡ãªã‚‹ã€Œãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆã‚¹ãƒˆãƒ¼ãƒ ã€ã®ã‚ˆã†ãªäº‹æ…‹ãŒé€£ç¶šã™ã‚Œã°ã€æœ€æ‚ªã®ã‚·ãƒŠãƒªã‚ªã§ã¯æ¯æ¸‡ã™ã‚‹å¯èƒ½æ€§ã‚‚æ®‹ã‚Šã¾ã™ã€‚
				<BR>è¨ˆç”»ã¯å„ªç§€ãªé ˜åŸŸã§ã™ãŒã€æ—¥æœ¬ã§ã¯æ­£ç¤¾å“¡ã‚’è¾ã‚ã‚‹ã¨ã„ã†è¡Œç‚ºã¯å–ã‚Šè¿”ã—ãŒã¤ã‹ãªã„ãŸã‚ã€å¸¸ã«å¸‚å ´ã‚’æ³¨è¦–ã™ã‚‹å§¿å‹¢ã¯å´©ã™ã¹ãã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`;
                } else if (successRate >= 90) {
                    stars = 'â­â­â­â­â˜†';
                    comment = `ã€è©•ä¾¡ï¼šé«˜ã„ç¢ºå®Ÿæ€§ã ãŒãƒªã‚¹ã‚¯ã‚ã‚Šã€‘ä¸€èˆ¬çš„ãªåŸºæº–ã§ã¯é«˜ã„ç¢ºå®Ÿæ€§ã§ã™ã€‚
				<BR>${(100 - successRate).toFixed(1)}%ã®ç¢ºç‡ã§è³‡ç”£ãŒå°½ãã‚‹æœªæ¥ãŒç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚
				<BR>äºˆæœŸã›ã¬å¤§ããªå‡ºè²»ã‚„ã€å¸‚å ´ãŒé•·æœŸé–“åœæ»ã™ã‚‹ã€Œãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆã‚¹ãƒˆãƒ¼ãƒ ã€ã®ã‚ˆã†ãªäº‹æ…‹ãŒé‡ãªã£ãŸå ´åˆã€è³‡ç”£ã¯æ¯æ¸‡ã—ã¾ã™ã€‚
				<BR>ã“ã®ãƒªã‚¹ã‚¯ã‚’çœŸå‰£ã«å—ã‘æ­¢ã‚ã€ä¸‡ãŒä¸€ã®å ´åˆã®åå…¥æºã‚’ç¢ºä¿ã™ã‚‹ãªã©ã€ã‚ˆã‚Šå³ã—ã„æ¤œè¨ãŒå¿…è¦ã§ã™ã€‚`;
                } else if (successRate >= 80) {
                    stars = 'â­â­â­â˜†â˜†';
                    comment = `ã€è©•ä¾¡ï¼šå±é™ºæ°´åŸŸãƒ»ååˆ†ãªæ¤œè¨ãŒå¿…è¦ã€‘FIREã®ç¢ºå®Ÿæ€§ã¨ã—ã¦ã¯ä¸ååˆ†ã§ã™ã€‚
					<BR>æˆåŠŸã¨å¤±æ•—ãŒç´„20%ã®å·®ã§ç™ºç”Ÿã—ã¦ãŠã‚Šã€è³‡ç”£ãŒæ¯æ¸‡ã™ã‚‹å¯èƒ½æ€§ã¯ååˆ†ã«ç™ºç”Ÿã™ã‚‹é ˜åŸŸã§ã™ã€‚
					<BR>ç‰¹ç•°ãªå‡ºè²»ã‚„ã€ä¸€æ™‚çš„ãªè‡ªå›½é€šè²¨å®‰ã€ã¾ãŸã¯ã‚¤ãƒ³ãƒ•ãƒ¬ã®äºˆæƒ³ä»¥ä¸Šã®é€²è¡ŒãŒé‡ãªã‚‹æœ€æ‚ªã®ã‚±ãƒ¼ã‚¹ã§ã¯ã€è¨ˆç”»ã¯å®¹æ˜“ã«ç ´ç¶»ã—ã¾ã™ã€‚
					<BR>è¨ˆç”»ã‚’å®Ÿè¡Œã«ç§»ã™å‰ã«ã€è³‡ç”£ã®å¢—å¼·ã‚„ç”Ÿæ´»è²»ã®è¦‹ç›´ã—ã‚’å¼·ãæ¨å¥¨ã—ã¾ã™ã€‚`;
                } else if (successRate >= 50) {
                    stars = 'â­â­â˜†â˜†â˜†';
                    comment = `ã€è©•ä¾¡ï¼šæ¥µã‚ã¦å±é™ºã€‘å¤±æ•—ã™ã‚‹ç¢ºç‡ãŒæˆåŠŸã™ã‚‹ç¢ºç‡ã¨ã»ã¨ã‚“ã©å¤‰ã‚ã‚Šã¾ã›ã‚“ã€‚
				<br>ã“ã®çŠ¶æ…‹ã§FIREã«è¸ã¿åˆ‡ã‚‹ã®ã¯æ¥µã‚ã¦å±é™ºã§ã™ã€‚å°‘ã—ã§ã‚‚æƒ³å®šå¤–ã®äº‹æ…‹ãŒç™ºç”Ÿã™ã‚Œã°ã€è³‡ç”£ã®æ¯æ¸‡ã¯æ™‚é–“ã®å•é¡Œã¨ãªã‚Šã¾ã™ã€‚
				<br>è¨ˆç”»ã®è¦‹ç›´ã—ã¯å¿…é ˆã§ã‚ã‚Šã€ç¾çŠ¶ã®ãƒ‡ãƒ¼ã‚¿ã§ã¯æ­£ç¤¾å“¡ã‚’è¾ã‚ã‚‹ã¹ãã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`;
                } else {
                    stars = 'â­â˜†â˜†â˜†â˜†';
                    comment = `ã€è©•ä¾¡ï¼šFIREä¸å¯èƒ½ã€‘ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å¤§åŠã§è³‡ç”£ãŒæ¯æ¸‡ã™ã‚‹ã¨ã„ã†çµæœã«ãªã‚Šã¾ã—ãŸã€‚
					<br>ã“ã®è¨ˆç”»ã§ã¯FIREã¯ä¸å¯èƒ½ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚
					<br>ç›´ã¡ã«å‡ºè²»ã®å‰Šæ¸›ã€åå…¥æºã®ç¢ºä¿ã€ã¾ãŸã¯æŠ•è³‡ãƒªã‚¿ãƒ¼ãƒ³ã®å†æ¤œè¨ï¼ˆãƒªã‚¹ã‚¯è¨±å®¹åº¦ã¨ã®ãƒãƒ©ãƒ³ã‚¹ã‚’è¦‹æ¥µã‚ã‚‹ï¼‰ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚`;
                }

		assessment = stars + "<BR>" + comment;
                if (successRate >= 50 && worst10thAsset <= 0) {
                    assessment += "<br>â†’ **ã€æ³¨æ„ã€‘** æˆåŠŸã‚±ãƒ¼ã‚¹ã§ã‚ã£ã¦ã‚‚ã€é‹ãŒæ‚ªã„ã¨è³‡ç”£ãŒã»ã¨ã‚“ã©æ®‹ã‚‰ãªã„ï¼ˆã¾ãŸã¯ãƒã‚¤ãƒŠã‚¹ã«ãªã‚‹ï¼‰å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚";
                }

                return assessment;
            }


            // --- ãƒ¡ã‚¤ãƒ³å‡¦ç† ---

            const storedData = localStorage.getItem('fireSimulatorData');
            if (!storedData) {
                summaryText.textContent = 'ã‚¨ãƒ©ãƒ¼: è¨­å®šãƒ‡ãƒ¼ã‚¿ãŒLocalStorageã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚è¨­å®šãƒšãƒ¼ã‚¸ã§ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚';
                return;
            }

            try {
                //å„ç¨®è¨­å®šãƒšãƒ¼ã‚¸ã®è¨­å®šæƒ…å ±ã®èª­ã¿è¾¼ã¿
                const appData = JSON.parse(storedData);
                window.appData = appData;

                if (!appData.stocks || appData.stocks.length === 0) {
                    summaryText.textContent = 'ã‚¨ãƒ©ãƒ¼: ä¿æœ‰éŠ˜æŸ„ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã§ãã¾ã›ã‚“ã€‚';
                    return;
                }

                // 1. ãƒ˜ãƒƒãƒ€ãƒ¼ã®åˆæœŸè¨­å®šã¨å‡¡ä¾‹ã®æº–å‚™
                setupTableHeader(appData.stocks);

                // 2. ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ (simulate.htmlã‚’é–‹ã„ãŸç›´å¾Œã«é–‹å§‹)
                simulationResults = runMonteCarloSimulation(appData);

                // 3. çµæœã®è¡¨ç¤º
                updateSimulationButtons(false);

                // 4. çµã‚Šè¾¼ã¿æ©Ÿèƒ½ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                failureFilter.addEventListener('change', (event) => {
                    updateSimulationButtons(event.target.checked);
                });

            } catch (e) {
                summaryText.textContent = `ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã¾ãŸã¯ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}`;
                debugOutput(`è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼: ${e.stack}`);
                document.getElementById('debug-output').style.display = 'block';
            }
        });

        //ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è©³ç´°ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®å„éŠ˜æŸ„ã®è³‡ç”£çŠ¶æ³ã®æ¨ç§»æƒ…å ±ã®è¡¨ç¤ºãƒ»éè¡¨ç¤ºå‡¦ç†
        document.addEventListener('DOMContentLoaded', () => {
            const table = document.getElementById('detail-table');
            if (!table) {
                return;
            }
            const meigaraHeaders = table.querySelectorAll('.meigara-header-group');
            meigaraHeaders.forEach(header => {
                header.addEventListener('click', (event) => {
                    //1è¡Œç›®ã®éŠ˜æŸ„é …ç›®ã«æ¨ªå¹…ã®æ¨™æº–åŒ–ãƒ»æœ€å°åŒ–ã®å‡¦ç†ã‚’è¡Œã†
                    // â˜…â˜…â˜… éŠ˜æŸ„ãƒ˜ãƒƒãƒ€ãƒ¼ã‚»ãƒ«è‡ªä½“ã«ç¸®å°ã‚¯ãƒ©ã‚¹ã‚’ãƒˆã‚°ãƒ«ã™ã‚‹ã ã‘ã«å¤‰æ›´ â˜…â˜…â˜…
                    event.currentTarget.classList.toggle('collapsed');
                    //ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸéŠ˜æŸ„ã®ç•ªå·ã‚’å–å¾—
                    const meigaraIndex = parseInt(event.currentTarget.dataset.meigaraIndex, 10);

                    //ï¼’è¡Œç›®ä»¥é™ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’ï¼‘ã«ã—ã¦è¦‹ãˆãªã„ã‚ˆã†ã«ã™ã‚‹
                    const isCollapsed = event.currentTarget.classList.contains('collapsed');
                    // éŠ˜æŸ„ã®é–‹å§‹åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨ˆç®— (1-based index)
                    const startColumnIndex_1based = 10 + (meigaraIndex * 4);
                    //éŠ˜æŸ„ã®è©³ç´°é …ç›®æ•°ã‚’å–å¾—
                    const COLUMNS_PER_STOCK = parseInt(event.currentTarget.getAttribute('colspan'), 10);
                    // ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã™ã¹ã¦ã®è¡Œ (ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã¨ãƒ‡ãƒ¼ã‚¿è¡Œ) ã‚’å–å¾—
                    const allRows = document.querySelectorAll('#detail-table tr');
                    allRows.forEach(row => {
                        // 4ã¤ã®åˆ—ã‚’ã¾ã¨ã‚ã¦æ“ä½œ
                        for (let i = 0; i < COLUMNS_PER_STOCK; i++) {
                            // è¡ŒãŒ 'header-row-2' ã®å ´åˆã€å…±é€šé …ç›®æ•°ã¯8ï¼ˆrowspan=2ã®å½±éŸ¿ã§1ã¤å°‘ãªã„ï¼‰
                            let columnIndex_1based = startColumnIndex_1based + i;
                            if (row.id === 'header-row-2') {	//ï¼’è¡Œç›®ã ã‘ç‰¹æ®Šãªã®ã§ã€å¯¾è±¡åˆ—ã‚’ï¼‘ã¤ãšã‚‰ã™
                                columnIndex_1based--;
                            }
                            // CSSã® :nth-child(n) ã‚»ãƒ¬ã‚¯ã‚¿ã‚’ä½¿ã£ã¦ã‚»ãƒ«ã‚’å–å¾—
                            const cell = row.querySelector(`:nth-child(${columnIndex_1based})`);
                            if (cell) {
                                if (isCollapsed) {
                                    // ç¸®å°æ™‚: ãƒ†ã‚­ã‚¹ãƒˆã‚’é€æ˜ã«
                                    cell.classList.add('collapsed-detail-text');
                                } else {
                                    // å±•é–‹æ™‚: ãƒ†ã‚­ã‚¹ãƒˆè‰²ã‚’é»’è‰²ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ã«æˆ»ã™
                                    cell.classList.remove('collapsed-detail-text');
                                }
                            }
                        }
                    });

                });
            });
        });
    </script>
</body>

</html>