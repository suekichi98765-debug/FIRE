<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åå…¥è¨­å®š</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>åå…¥è¨­å®š</h1>
            <p>æ¯æœˆã®åå…¥ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®šã—ã¾ã™ã€‚</p>
        </header>

        <main>
            <div class="input-section">
                <h2>åå…¥ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§</h2>
                <div class="instruction-box">
                    <p><strong>ğŸ’¡ å…¥åŠ›æ–¹æ³•:</strong></p>
                    <ul>
                        <li><strong>é–‹å§‹å¹´/æœˆ:</strong> åå…¥ãŒç™ºç”Ÿã—å§‹ã‚ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’è¨­å®šã—ã¾ã™ã€‚</li>
                        <li><strong>çµ‚äº†å¹´/æœˆ:</strong> åå…¥ãŒçµ‚äº†ã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’è¨­å®šã—ã¾ã™ã€‚</li>
                        <li><strong>çµ‚äº†å¹´/æœˆãŒç©ºæ¬„:</strong> é–‹å§‹å¹´/æœˆã‹ã‚‰ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æœŸé–“ã®çµ‚ã‚ã‚Šã¾ã§ã€æ¯æœˆåå…¥ãŒç™ºç”Ÿã—ç¶šã‘ã¾ã™ã€‚</li>
                        <li><strong>0å¹´0æœˆã¾ãŸã¯0å¹´1æœˆ:</strong> ã©ã¡ã‚‰ã‚‚ã€Œã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹æœˆã€ã‚’æ„å‘³ã—ã¾ã™ã€‚</li>
                    </ul>
                </div>
                <div id="incomeContainer">
                    </div>
                <div class="form-actions">
                    <button id="addIncomeBtn" type="button">åå…¥ã‚’è¿½åŠ </button>
                    <button id="saveIncomeBtn" class="save-button">è¨­å®šã‚’ä¿å­˜</button>
                </div>
            </div>

            <div class="back-link">
                <a href="index.html" class="nav-button">ãƒ¡ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹</a>
            </div>
        </main>
    </div>

    <script src="app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const incomeContainer = document.getElementById('incomeContainer');
            const addIncomeBtn = document.getElementById('addIncomeBtn');
            const saveIncomeBtn = document.getElementById('saveIncomeBtn');

            const createIncomeItem = (index, incomeData = {}) => {
                const incomeItem = document.createElement('div');
                incomeItem.classList.add('income-item');
                incomeItem.innerHTML = `
                    <h3>åå…¥ã‚¤ãƒ™ãƒ³ãƒˆ ${index + 1}</h3>
                    <div class="form-group input-group">
                        <label>é–‹å§‹å¹´/æœˆ:</label>
                        <input type="number" class="income-start-year" placeholder="å¹´" value="${incomeData.startTotalMonths !== undefined ? Math.floor(incomeData.startTotalMonths / 12) : ''}" required>
                        <span>å¹´</span>
                        <input type="number" class="income-start-month" placeholder="æœˆ" value="${incomeData.startTotalMonths !== undefined ? (incomeData.startTotalMonths % 12) + 1 : ''}" required>
                        <span>æœˆ</span>
                    </div>
                    <div class="form-group input-group">
                        <label>çµ‚äº†å¹´/æœˆ:</label>
                        <input type="number" class="income-end-year" placeholder="å¹´" value="${incomeData.endTotalMonths !== null && incomeData.endTotalMonths !== undefined ? Math.floor(incomeData.endTotalMonths / 12) : ''}">
                        <span>å¹´</span>
                        <input type="number" class="income-end-month" placeholder="æœˆ" value="${incomeData.endTotalMonths !== null && incomeData.endTotalMonths !== undefined ? (incomeData.endTotalMonths % 12) + 1 : ''}">
                        <span>æœˆ</span>
                    </div>
                    <div class="form-group">
                        <label>åå…¥é¡ï¼ˆå††/æœˆï¼‰:</label>
                        <input type="text" class="income-amount" value="${incomeData.amount || ''}" inputmode="numeric" pattern="[0-9,]*" required>
                    </div>
                    <div class="form-group">
                        <label>ç†ç”±ï¼ˆä»»æ„ï¼‰:</label>
                        <input type="text" class="income-reason" value="${incomeData.reason || ''}">
                    </div>
                    <button type="button" class="remove-btn">å‰Šé™¤</button>
                `;
                
                incomeItem.querySelector('.remove-btn').addEventListener('click', () => {
                    incomeItem.remove();
                    updateIncomeNumbers();
                });

                return incomeItem;
            };

            const updateIncomeNumbers = () => {
                const items = document.querySelectorAll('.income-item');
                items.forEach((item, index) => {
                    item.querySelector('h3').textContent = `åå…¥ã‚¤ãƒ™ãƒ³ãƒˆ ${index + 1}`;
                });
            };

            const loadIncomes = () => {
                const appData = JSON.parse(localStorage.getItem('fireSimulatorData')) || {};
                const income = appData.income || [];
                incomeContainer.innerHTML = '';
                if (income.length > 0) {
                    income.forEach((data, index) => {
                        incomeContainer.appendChild(createIncomeItem(index, data));
                    });
                } else {
                    incomeContainer.appendChild(createIncomeItem(0));
                }
                updateIncomeNumbers();
                document.querySelectorAll('input[inputmode="numeric"]').forEach(input => {
                    if (input.value) {
                        const value = input.value.replace(/,/g, '');
                        input.value = value.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                    }
                    input.addEventListener('input', formatNumberInput);
                });
            };

            addIncomeBtn.addEventListener('click', () => {
                const index = incomeContainer.children.length;
                const newIncomeItem = createIncomeItem(index);
                incomeContainer.appendChild(newIncomeItem);
                updateIncomeNumbers();
                newIncomeItem.querySelectorAll('input[inputmode="numeric"]').forEach(input => {
                    input.addEventListener('input', formatNumberInput);
                });
            });

            saveIncomeBtn.addEventListener('click', () => {
                const incomeData = [];
                let isValid = true;
                
                document.querySelectorAll('.income-item').forEach(item => {
                    const startYearInput = item.querySelector('.income-start-year');
                    const startMonthInput = item.querySelector('.income-start-month');
                    const endYearInput = item.querySelector('.income-end-year');
                    const endMonthInput = item.querySelector('.income-end-month');
                    const amountInput = item.querySelector('.income-amount');
                    const reasonInput = item.querySelector('.income-reason');

                    const startYear = parseInt(startYearInput.value, 10);
                    const startMonth = parseInt(startMonthInput.value, 10);
                    const amount = parseInt(amountInput.value.replace(/,/g, ''), 10);
                    const reason = reasonInput.value;
                    
                    let endYear = endYearInput.value ? parseInt(endYearInput.value, 10) : null;
                    let endMonth = endMonthInput.value ? parseInt(endMonthInput.value, 10) : null;

                    if (startYear === 0 && startMonth === 0) {
                        startMonth = 1;
                    }
                    if (endYear === 0 && endMonth === 0) {
                        endMonth = 1;
                    }

                    if (isNaN(startYear) || isNaN(startMonth) || startYear < 0 || startMonth < 1 || startMonth > 12) {
                        alert('é–‹å§‹å¹´/æœˆã¯æ­£ã—ã„æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                        isValid = false;
                        startYearInput.classList.add('error-input');
                        startMonthInput.classList.add('error-input');
                        return;
                    }
                    if ((endYear !== null && isNaN(endYear)) || (endMonth !== null && isNaN(endMonth))) {
                        alert('çµ‚äº†å¹´/æœˆã¯æ­£ã—ã„æ•°å€¤ã‚’å…¥åŠ›ã™ã‚‹ã‹ã€ä¸¡æ–¹ç©ºæ¬„ã«ã—ã¦ãã ã•ã„ã€‚');
                        isValid = false;
                        endYearInput.classList.add('error-input');
                        endMonthInput.classList.add('error-input');
                        return;
                    }
                    if ((endYear === null && endMonth !== null) || (endYear !== null && endMonth === null)) {
                        alert('çµ‚äº†å¹´/æœˆã¯ä¸¡æ–¹å…¥åŠ›ã™ã‚‹ã‹ã€ä¸¡æ–¹ç©ºæ¬„ã«ã—ã¦ãã ã•ã„ã€‚');
                        isValid = false;
                        endYearInput.classList.add('error-input');
                        endMonthInput.classList.add('error-input');
                        return;
                    }

                    const startTotalMonths = startYear * 12 + (startMonth - 1);
                    const endTotalMonths = (endYear !== null && endMonth !== null) ? endYear * 12 + (endMonth - 1) : null;
                    
                    if (endTotalMonths !== null && startTotalMonths > endTotalMonths) {
                         alert('é–‹å§‹å¹´/æœˆã¯çµ‚äº†å¹´/æœˆã‚ˆã‚Šã‚‚å‰ã®æœˆã«è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                         isValid = false;
                         startYearInput.classList.add('error-input');
                         startMonthInput.classList.add('error-input');
                         endYearInput.classList.add('error-input');
                         endMonthInput.classList.add('error-input');
                         return;
                    }

                    startYearInput.classList.remove('error-input');
                    startMonthInput.classList.remove('error-input');
                    endYearInput.classList.remove('error-input');
                    endMonthInput.classList.remove('error-input');

                    incomeData.push({
                        startTotalMonths: startTotalMonths,
                        endTotalMonths: endTotalMonths,
                        amount: amount,
                        reason: reason
                    });
                });

                if (!isValid) {
                    return;
                }

                const appData = JSON.parse(localStorage.getItem('fireSimulatorData')) || {};
                appData.income = incomeData.sort((a, b) => a.startTotalMonths - b.startTotalMonths);
                localStorage.setItem('fireSimulatorData', JSON.stringify(appData));
                alert('åå…¥ã®è¨­å®šãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼');
            });

            loadIncomes();
        });
    </script>
</body>
</html>